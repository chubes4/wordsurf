(()=>{"use strict";const e=window.React,t=window.wp.plugins,n=window.wp.editPost,r=window.wp.i18n,o=window.wp.element,i=window.wp.data,a=({name:t,status:n})=>(0,e.createElement)("div",{className:"tool-call"},"in_progress"===n?(0,e.createElement)("div",{className:"spinner"}):"success"===n?(0,e.createElement)("div",{className:"icon"},"✅"):"error"===n?(0,e.createElement)("div",{className:"icon"},"❌"):null,(0,e.createElement)("span",{className:"tool-call-name"},t),"in_progress"!==n&&(0,e.createElement)("span",{className:"tool-call-status"},n)),s=({initialMessages:t=[],postId:n,onSend:r,onDiffReceived:o})=>{const[i,s]=(0,e.useState)(t),[c,l]=(0,e.useState)(""),[d,p]=(0,e.useState)(!1),[u,f]=(0,e.useState)(""),[h,m]=(0,e.useState)([]),[g,E]=(0,e.useState)(!1),w=(0,e.useRef)(""),D=(0,e.useRef)(null);(0,e.useEffect)(()=>{D.current&&(D.current.scrollTop=D.current.scrollHeight)},[i,u,h]);const N=async()=>{if(!c.trim()||d)return;const e=c.trim(),t=[...i.map(e=>"user"===e.author?{role:"user",content:e.content}:{role:"assistant",content:e.content}),{role:"user",content:e}];s(t=>[...t,{author:"user",content:e}]),l(""),p(!0),f(""),m([]),w.current="",E(!0),r&&r(e),await async function(e,t,n,r,o){console.log("Wordsurf DEBUG: streamChatMessage called with messages:",e),console.log("Wordsurf DEBUG: postId:",t);try{const o=new FormData;o.append("action","wordsurf_stream_chat"),o.append("messages",JSON.stringify(e)),o.append("post_id",t),o.append("nonce",window.wordsurfData?.nonce||"");const i=await fetch("/wp-admin/admin-ajax.php",{method:"POST",body:o});if(!i.body)throw new Error("No response body");const a=i.body.getReader(),s=new TextDecoder;let c="";for(;;){const{value:e,done:t}=await a.read();if(t)break;c+=s.decode(e,{stream:!0});let r=c.split("\n\n");c=r.pop();for(const e of r)if(e.startsWith("data: ")){const t=e.replace("data: ","");try{n(JSON.parse(t))}catch(e){console.error("Wordsurf DEBUG: JSON parse error:",e.message,"for event:",t)}}}r&&r()}catch(e){console.error("Wordsurf DEBUG: Stream error:",e),o&&o()}}(t,n,e=>{E(!1),e.type&&e.data&&("tool_start"===e.type?m(t=>[...t,{name:e.data.name,status:"in_progress"}]):"tool_end"===e.type?(m(t=>t.map(t=>t.name===e.data.name?{...t,status:e.data.status}:t)),("edit_post"===e.data.name||"insert_content"===e.data.name||"write_to_post"===e.data.name)&&e.data.result&&e.data.result.preview&&o&&o(e.data.result)):"system"===e.type?m(t=>[...t,{name:e.data.content,status:"system"}]):"text"===e.type&&(h.length>0&&m([]),e.data.content&&(w.current+=e.data.content,f(w.current))))},()=>{w.current&&s(e=>[...e,{author:"agent",content:w.current}]),f(""),m([]),p(!1),E(!1)},e=>{p(!1),m([]),f(""),E(!1),s(e=>[...e,{author:"agent",content:"Sorry, there was an error."}])})};return(0,e.createElement)("div",{className:"wordsurf-sidebar-content"},(0,e.createElement)("div",{className:"wordsurf-chat-window",ref:D},i.map((t,n)=>(0,e.createElement)("div",{key:n,className:`chat-message ${t.author}`},(0,e.createElement)("div",{className:"chat-bubble"},t.content))),g&&(0,e.createElement)(a,{name:"Thinking...",status:"system"}),h.map((t,n)=>(0,e.createElement)(a,{key:n,name:t.name,status:t.status})),d&&u&&(0,e.createElement)("div",{className:"chat-message agent"},(0,e.createElement)("div",{className:"chat-bubble"},u,(0,e.createElement)("span",{className:"typing-indicator"},(0,e.createElement)("span",null),(0,e.createElement)("span",null),(0,e.createElement)("span",null))))),(0,e.createElement)("div",{className:"wordsurf-input-area"},(0,e.createElement)("textarea",{value:c,onChange:e=>l(e.target.value),placeholder:"Ask me to edit, write, or brainstorm...",disabled:d,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),N())}}),(0,e.createElement)("button",{onClick:N,disabled:d||!c.trim()},"Send")))};class c{constructor(e,t,n,r){this.diffData=e,this.editorDocument=t,this.onAccept=n,this.onReject=r,this.originalElements=[],this.toolType="base"}createHighlight(){throw new Error("createHighlight() must be implemented by subclasses")}onAcceptDiff(){this.replaceWithAcceptedContent(),this.onAccept(this.diffData)}onRejectDiff(){this.cleanup(),this.onReject(this.diffData)}createActionButtons(){const e=this.editorDocument.createElement("span");e.className="wordsurf-diff-actions";const t=this.editorDocument.createElement("button");t.className="wordsurf-diff-btn wordsurf-diff-accept",t.innerHTML="✓",t.title=this.getAcceptButtonTitle(),t.onclick=e=>{e.preventDefault(),e.stopPropagation(),this.onAcceptDiff()};const n=this.editorDocument.createElement("button");return n.className="wordsurf-diff-btn wordsurf-diff-reject",n.innerHTML="✗",n.title=this.getRejectButtonTitle(),n.onclick=e=>{e.preventDefault(),e.stopPropagation(),this.onRejectDiff()},e.appendChild(t),e.appendChild(n),e}getAcceptButtonTitle(){return{edit_post:"Accept change",insert_content:"Accept insertion",write_to_post:"Accept replacement"}[this.toolType]||"Accept"}getRejectButtonTitle(){return{edit_post:"Reject change",insert_content:"Reject insertion",write_to_post:"Reject replacement"}[this.toolType]||"Reject"}cleanup(){this.originalElements.forEach(({wrapper:e,originalNode:t})=>{e.parentNode&&(t?e.parentNode.replaceChild(t,e):e.parentNode.removeChild(e))}),this.originalElements=[]}replaceWithAcceptedContent(){this.originalElements.forEach(({wrapper:e,originalNode:t})=>{e.parentNode&&(t?e.parentNode.replaceChild(t,e):e.parentNode.removeChild(e))}),this.originalElements=[]}trackElement(e,t=null){this.originalElements.push({wrapper:e,originalNode:t})}findTextNodesWithPattern(e){const t=this.editorDocument.createTreeWalker(this.editorDocument.body,NodeFilter.SHOW_TEXT,{acceptNode:function(t){const n=t.parentElement;return n?["SCRIPT","STYLE"].includes(n.tagName)||n.classList.contains("wordsurf-diff-highlight")?NodeFilter.FILTER_REJECT:t.textContent.includes(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT:NodeFilter.FILTER_REJECT}}),n=[];let r;for(;r=t.nextNode();)n.push(r);return n}}function l(e){return e.split(/(\s+|[.,!?;:"'()[\]{}])/).filter(e=>e.length>0)}function d(e,t){const n=l(e),r=l(t),o=function(e,t){const n=Array(e.length+1).fill(null).map(()=>Array(t.length+1).fill(0));for(let r=1;r<=e.length;r++)for(let o=1;o<=t.length;o++)e[r-1]===t[o-1]?n[r][o]=n[r-1][o-1]+1:n[r][o]=Math.max(n[r-1][o],n[r][o-1]);return n}(n,r),i=function(e,t,n){const r=[];let o=t.length,i=n.length;for(;o>0||i>0;)o>0&&i>0&&t[o-1]===n[i-1]?(r.unshift({type:"equal",text:t[o-1]}),o--,i--):i>0&&(0===o||e[o][i-1]>=e[o-1][i])?(r.unshift({type:"insert",text:n[i-1]}),i--):o>0&&(r.unshift({type:"delete",text:t[o-1]}),o--);return r}(o,n,r);return i}function p(e){const t=[];let n=null;for(const r of e)n&&n.type===r.type?n.text+=r.text:(n&&t.push(n),n={...r});return n&&t.push(n),t}const u={edit_post:class extends c{constructor(e,t,n,r){super(e,t,n,r),this.toolType="edit_post"}createHighlight(){const e=this.diffData.search_pattern;this.findTextNodesWithPattern(e).forEach(t=>{this.highlightTextNode(t,e)})}highlightTextNode(e,t){const n=e.parentElement,r=e.textContent;if(!r.includes(t))return;const o=r.substring(0,r.indexOf(t)),i=r.substring(r.indexOf(t)+t.length),a=this.editorDocument.createElement("span");a.className="wordsurf-diff-wrapper",o&&a.appendChild(this.editorDocument.createTextNode(o));const s=this.createDiffContainer(t);a.appendChild(s);const c=this.createActionButtons();a.appendChild(c),i&&a.appendChild(this.editorDocument.createTextNode(i)),n.replaceChild(a,e),this.trackElement(a,e)}createDiffContainer(e){const t=this.editorDocument.createElement("span");t.className="wordsurf-diff-highlight";const{wordDiffHTML:n,tooltipHTML:r}=function(e,t,n){const r=p(d(e,t)),o=n.createElement("span");o.className="wordsurf-wp-diff";let i="ORIGINAL TEXT:\n";for(const e of r){if("equal"===e.type||"insert"===e.type){const t=n.createElement("span");"insert"===e.type?t.className="wordsurf-diff-inserted":t.className="wordsurf-diff-equal",t.textContent=e.text,o.appendChild(t)}"equal"===e.type?i+=e.text:"delete"===e.type&&(i+=`[REMOVED: ${e.text}]`)}return{wordDiffHTML:o,tooltipHTML:i}}(e,this.diffData.replacement_text,this.editorDocument);for(;t.firstChild;)t.removeChild(t.firstChild);for(;n.firstChild;)t.appendChild(n.firstChild);return t.setAttribute("data-diff-tooltip",r),t.setAttribute("data-original-text",e),t.setAttribute("data-new-text",this.diffData.replacement_text),t.setAttribute("data-tool-type",this.toolType),t}replaceWithAcceptedContent(){this.originalElements.forEach(({wrapper:e,originalNode:t})=>{if(e.parentNode&&t){const n=t.ownerDocument.createTextNode(this.diffData.replacement_text);e.parentNode.replaceChild(n,e)}else e.parentNode&&e.parentNode.removeChild(e)}),this.originalElements=[]}},insert_content:class extends c{constructor(e,t,n,r){super(e,t,n,r),this.toolType="insert_content"}createHighlight(){const e=this.findInsertionPoint();e&&this.createInsertionPreview(e)}findInsertionPoint(){const e=this.diffData.position,t=this.diffData.target_paragraph_text;return"beginning"===e?this.editorDocument.body.firstChild:"end"===e?this.editorDocument.body.lastChild:"after_paragraph"===e&&t?this.findParagraphWithText(t):null}findParagraphWithText(e){let t=this.editorDocument.createTreeWalker(this.editorDocument.body,NodeFilter.SHOW_TEXT,{acceptNode:function(t){return t.textContent.includes(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}).nextNode();if(t){let e=t.parentElement;for(;e&&"P"!==e.tagName;)e=e.parentElement;return e}return null}createInsertionPreview(e){const t=this.diffData.position,n=this.diffData.replacement_text,r=this.editorDocument.createElement("div");r.className="wordsurf-diff-wrapper wordsurf-insertion-preview",r.style.cssText="\n      margin: 10px 0;\n      padding: 10px;\n      border: 2px dashed #34d058;\n      background: rgba(52, 208, 88, 0.1);\n      border-radius: 4px;\n    ";const o=this.createDiffContainer(n);r.appendChild(o);const i=this.createActionButtons();r.appendChild(i),this.insertAtPosition(r,e,t),this.trackElement(r,null)}createDiffContainer(e){const t=this.editorDocument.createElement("span");return t.className="wordsurf-diff-highlight",t.textContent=e,t.setAttribute("data-new-text",e),t.setAttribute("data-tool-type",this.toolType),t.title=`NEW CONTENT: "${e}"`,t}insertAtPosition(e,t,n){"beginning"===n?t.parentNode.insertBefore(e,t):"end"===n?t.parentNode.appendChild(e):"after_paragraph"===n&&t.parentNode.insertBefore(e,t.nextSibling)}getAcceptButtonTitle(){return"Accept insertion"}getRejectButtonTitle(){return"Reject insertion"}},write_to_post:class extends c{constructor(e,t,n,r){super(e,t,n,r),this.toolType="write_to_post"}createHighlight(){const e=this.diffData.search_pattern;this.findTextNodesWithPattern(e).forEach(t=>{this.highlightTextNode(t,e)})}highlightTextNode(e,t){const n=e.parentElement,r=e.textContent;if(!r.includes(t))return;const o=r.substring(0,r.indexOf(t)),i=r.substring(r.indexOf(t)+t.length),a=this.editorDocument.createElement("span");a.className="wordsurf-diff-wrapper",o&&a.appendChild(this.editorDocument.createTextNode(o));const s=this.createDiffContainer(t);a.appendChild(s);const c=this.createActionButtons();a.appendChild(c),i&&a.appendChild(this.editorDocument.createTextNode(i)),n.replaceChild(a,e),this.trackElement(a,e)}createDiffContainer(e){const t=this.editorDocument.createElement("span");t.className="wordsurf-diff-highlight",t.textContent=this.diffData.replacement_text;const n=function(e,t){if(!e||""===e.trim())return`ADDED: "${t}"`;if(e.length<=50&&t.length<=50)return`REMOVED: "${e}"\nADDED: "${t}"`;const n=p(d(e,t));let r="",o=!1,i=!1;for(const e of n)"delete"===e.type&&(o||(r+="REMOVED: ",o=!0),r+=e.text);o&&(r+="\n");for(const e of n)"insert"===e.type&&(i||(r+="ADDED: ",i=!0),r+=e.text);return r||`CHANGED: "${e}" → "${t}"`}(e,this.diffData.replacement_text);return t.setAttribute("data-diff-tooltip",n),t.setAttribute("data-original-text",e),t.setAttribute("data-new-text",this.diffData.replacement_text),t.setAttribute("data-tool-type",this.toolType),t}getAcceptButtonTitle(){return"Accept replacement"}getRejectButtonTitle(){return"Reject replacement"}}},f=({diffData:t,onAccept:n,onReject:r,onClose:o})=>{const[i,a]=(0,e.useState)(!1),s=(0,e.useRef)(null);return(0,e.useEffect)(()=>{if(!t)return;const e=document.querySelector(".edit-post-visual-editor__content-area iframe");let o=document;e&&(o=e.contentDocument||e.contentWindow.document);const i=setTimeout(()=>{try{const e=function(e,t,n,r){const o=e.tool_type||"edit_post",i=u[o];if(!i)throw new Error(`Unknown tool type: ${o}. Available tools: ${Object.keys(u).join(", ")}`);return new i(e,t,n,r)}(t,o,n,r);s.current=e,e.createHighlight(),a(!0)}catch(e){console.error("Failed to create diff handler:",e),r(t)}},100);return()=>{clearTimeout(i)}},[t,n,r]),(0,e.useEffect)(()=>()=>{s.current&&(s.current.cleanup(),s.current=null),a(!1)},[]),null},h="wordsurf",m=(0,r.__)("Wordsurf","wordsurf"),g=()=>(0,e.createElement)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},(0,e.createElement)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z",fill:"currentColor"}),(0,e.createElement)("path",{d:"M12 12m-6 0a6 6 0 1 0 12 0a6 6 0 1 0 -12 0",fill:"currentColor","fill-opacity":"0.3"}));(0,t.registerPlugin)(h,{render:()=>{const[t,r]=(0,o.useState)([]),a=(0,i.useDispatch)(),c=(0,i.useSelect)(e=>{const{getCurrentPostId:t,getEditedPostAttribute:n}=e("core/editor");return{postId:t(),title:n("title"),content:n("content"),status:n("status"),type:n("type")}}),l=e=>{if(!e)return;const t=e.content_type||e.edit_type||"content";"content"===t?a("core/editor").editPost({content:e.new_content}):"title"===t?a("core/editor").editPost({title:e.new_content}):"excerpt"===t&&a("core/editor").editPost({excerpt:e.new_content});const n=e.inserted_content?"inserted":"updated",o=e.insertion_point?` ${e.insertion_point}`:"";a("core/notices").createSuccessNotice(`✅ Changes applied! Content ${n}${o} successfully.`,{type:"snackbar",isDismissible:!0}),p("accepted",e),r(t=>t.filter(t=>t!==e))},d=e=>{a("core/notices").createInfoNotice(`❌ Changes rejected. No modifications were made to the ${e.edit_type}.`,{type:"snackbar",isDismissible:!0}),p("rejected",e),r(t=>t.filter(t=>t!==e))},p=async(e,t)=>{try{const n=new FormData;n.append("action","wordsurf_user_feedback"),n.append("user_action",e),n.append("tool_type",t.tool_type||"edit_post"),n.append("post_id",c.postId),n.append("nonce",window.wordsurfData?.nonce||""),await fetch("/wp-admin/admin-ajax.php",{method:"POST",body:n})}catch(e){console.error("Failed to send AI feedback:",e)}};return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(n.PluginSidebarMoreMenuItem,{target:h},m),(0,e.createElement)(n.PluginSidebar,{name:h,title:m,icon:(0,e.createElement)(g,null)},(0,e.createElement)(s,{postId:c.postId,onSend:e=>{console.log("Message sent:",e)},onDiffReceived:e=>{r(t=>[...t,e])}})),t.map((t,n)=>(0,e.createElement)(f,{key:n,diffData:t,onAccept:l,onReject:d,onClose:()=>r(e=>e.filter(e=>e!==t))})))}})})();