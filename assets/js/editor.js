(()=>{"use strict";var e={20:(e,t,s)=>{var n=s(609),r=Symbol.for("react.element"),a=(Symbol.for("react.fragment"),Object.prototype.hasOwnProperty),o=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};t.jsx=function(e,t,s){var n,l={},c=null,d=null;for(n in void 0!==s&&(c=""+s),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(d=t.ref),t)a.call(t,n)&&!i.hasOwnProperty(n)&&(l[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===l[n]&&(l[n]=t[n]);return{$$typeof:r,type:e,key:c,ref:d,props:l,_owner:o.current}}},609:e=>{e.exports=window.React},848:(e,t,s)=>{e.exports=s(20)}},t={};function s(n){var r=t[n];if(void 0!==r)return r.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,s),a.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};s.r(n),s.d(n,{closeModal:()=>L,disableComplementaryArea:()=>T,enableComplementaryArea:()=>B,openModal:()=>H,pinItem:()=>U,setDefaultComplementaryArea:()=>P,setFeatureDefaults:()=>O,setFeatureValue:()=>j,toggleFeature:()=>x,unpinItem:()=>N});var r={};s.r(r),s.d(r,{getActiveComplementaryArea:()=>F,isComplementaryAreaLoading:()=>W,isFeatureActive:()=>$,isItemPinned:()=>V,isModalActive:()=>z});var a=s(609),o=s.n(a);const i=window.wp.plugins,l=window.wp.editor,c=window.wp.i18n,d=window.wp.element,u=window.wp.data;function g(e,t,s,n,r){const a=new URLSearchParams({action:"wordsurf_stream_chat",messages:JSON.stringify(e),post_id:t,context_window:JSON.stringify({}),nonce:window.wordsurfData?.nonce||""}),o=new EventSource(`${window.wordsurfData.ajax_url}?${a.toString()}`);let i=!1,l=!1,c=!1;return o.onmessage=function(e){console.log("🚀 DEFAULT MESSAGE EVENT:",e.type,e.data)},o.onopen=function(e){console.log("🟢 EventSource connection opened")},o.onerror=function(e){console.log("🔴 EventSource error event:",e,"readyState:",o.readyState)},o.addEventListener("response.output_text.delta",e=>{try{const t=JSON.parse(e.data);t.delta&&s({type:"text",data:{content:t.delta}})}catch(t){console.error("Failed to parse text delta:",e.data,t)}}),o.addEventListener("response.output_item.added",e=>{try{const t=JSON.parse(e.data);t.item&&"function_call"===t.item.type&&(c=!0,s({type:"tool_start",data:t.item}))}catch(t){console.error("Failed to parse tool start:",e.data,t)}}),o.addEventListener("tool_result",e=>{console.log("🔧 TOOL_RESULT EVENT RECEIVED:",e.data),console.log("🔧 Event object:",e),console.log("🔧 EventSource readyState:",o.readyState);try{const t=JSON.parse(e.data);console.log("🔧 Parsed tool result:",t),console.log("🔧 About to call onEvent with:",{type:"tool_result",data:t}),s({type:"tool_result",data:t}),l=!0,o.close(),n&&n()}catch(t){console.error("Failed to parse tool result:",e.data,t)}}),o.addEventListener("response.completed",e=>{i=!0;try{const t=JSON.parse(e.data);console.log("StreamApi: Stream completed by API.",t),s({type:"stream_end",data:t.response}),c?console.log("StreamApi: Stream completed, keeping connection open for tool results"):(console.log("StreamApi: Stream completed, no tools detected, closing immediately"),l=!0,o.close(),n&&n())}catch(t){console.error("Failed to parse response.completed event:",e.data,t),s({type:"stream_end",data:{status:"completed"}}),l||(console.log("StreamApi: Parse error recovery - closing connection immediately"),l=!0,o.close(),n&&n())}}),o.addEventListener("message",e=>{e.type.startsWith("response.")||console.log("StreamApi: Received unexpected message event:",e)}),o.addEventListener("error",e=>{l||(l=!0,o.close()),i||o.readyState===EventSource.CLOSED||(console.error("StreamApi: EventSource error:",e),r&&r(e))}),o}class f{constructor(e,t){this.chatHistory=e,this.onDiffReceived=t,this.isStreaming=!1,this.isWaiting=!1,this.streamingBuffer="",this.accumulatedContent="",this.hasSentMessage=!1,this.currentEventSource=null,this.animationFrameId=null,this.onUIUpdate=null,this.streamingMessageIndex=-1}startStream(e,t,s,n,r,a){this.isStreaming||this.hasSentMessage||this.currentEventSource||(this.isStreaming=!0,this.isWaiting=!0,this.hasSentMessage=!0,this.streamingBuffer="",this.accumulatedContent="",this.onUIUpdate=a,this.streamingMessageIndex=-1,this.currentEventSource=s(e,t,e=>this.handleEvent(e),()=>this.handleComplete(n),e=>this.handleError(r,e)),this.onUIUpdate&&this.onUIUpdate())}handleEvent(e){if(e.type&&e.data){switch(e.type){case"tool_start":this.isWaiting=!1,this.flushStreamingBuffer(),this.chatHistory.addToolCall(e.data.call_id,e.data.name,e.data.arguments),this.finalizeStreamingMessage();break;case"text":this.isWaiting=!1,null!=e.data.content&&(this.streamingBuffer+=e.data.content,this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>{this.flushStreamingBuffer(),this.onUIUpdate&&this.onUIUpdate()})));break;case"stream_end":this.finalizeStreamingMessage();break;case"tool_result":this.isWaiting=!1;const{tool_call_id:t,tool_name:s,result:n}=e.data;console.log("ChatStreamSession: Received tool_result:",{tool_call_id:t,tool_name:s,result:n,preview:n.preview,hasCallback:!!this.onDiffReceived}),this.chatHistory.updateToolCall(t,{success:n.success,completed:!0,...n}),!0===n.preview&&this.onDiffReceived?(console.log("ChatStreamSession: CALLING onDiffReceived with diff data"),console.log("ChatStreamSession: Full result data:",n),this.onDiffReceived({tool_call_id:t,original_content:n.original_content,new_content:n.new_content,search_pattern:n.search_pattern,replacement_text:n.replacement_text,diff_block_content:n.diff_block_content,target_blocks:n.target_blocks,diff_id:n.diff_id,tool_name:s,message:n.message})):console.log("ChatStreamSession: NOT calling onDiffReceived because:",{hasPreview:!0===n.preview,hasCallback:!!this.onDiffReceived,preview:n.preview})}this.onUIUpdate&&this.onUIUpdate()}}flushStreamingBuffer(){this.streamingBuffer.length>0&&(this.accumulatedContent+=this.streamingBuffer,-1===this.streamingMessageIndex?(this.chatHistory.addAssistantMessage(this.accumulatedContent,!0),this.streamingMessageIndex=this.chatHistory.getMessageCount()-1):this.chatHistory.updateMessageContent(this.streamingMessageIndex,this.accumulatedContent),this.streamingBuffer=""),this.animationFrameId=null}finalizeStreamingMessage(){-1!==this.streamingMessageIndex&&this.chatHistory.updateMessageStreamingStatus(this.streamingMessageIndex,!1)}handleComplete(e){this.streamingBuffer.length>0&&this.flushStreamingBuffer(),this.finalizeStreamingMessage(),this.isStreaming=!1,this.isWaiting=!1,this.hasSentMessage=!1,this.currentEventSource=null,this.streamingMessageIndex=-1,this.accumulatedContent="",e&&e(),this.onUIUpdate&&this.onUIUpdate()}handleError(e,t){this.streamingBuffer.length>0?this.flushStreamingBuffer():0===this.accumulatedContent.length&&this.chatHistory.addAssistantMessage("Sorry, there was an error.",!1),this.finalizeStreamingMessage(),this.isStreaming=!1,this.isWaiting=!1,this.hasSentMessage=!1,this.currentEventSource=null,this.streamingMessageIndex=-1,this.accumulatedContent="",e&&e(t),this.onUIUpdate&&this.onUIUpdate()}getState(){return{isStreaming:this.isStreaming,isWaiting:this.isWaiting,uiMessages:this.chatHistory.getUIMessages(),hasStreamingAssistant:this.hasStreamingAssistantMessage()}}hasStreamingAssistantMessage(){return this.chatHistory.getUIMessages().some(e=>"assistant"===e.role&&e.isStreaming)}setInputValue(e){this.inputValue=e}getInputValue(){return this.inputValue||""}cleanup(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.currentEventSource&&this.currentEventSource.close()}}function p(e){if(!e.role)throw new Error("Message must have a role property");if(!["user","assistant","tool","system"].includes(e.role))throw new Error(`Invalid role: ${e.role}`);return e}function h(e){return e.map(p)}function m(e){return{role:"user",content:e,type:"text",author:"user"}}class y{constructor(){this.pendingToolResults=new Map}createToolCall(e,t,s){return function(e,t,s){return{role:"assistant",id:e,author:"agent",type:"tool",tool_name:t,tool_args:s,result:null,isStreaming:!0}}(e,t,s)}createToolResult(e,t){return function(e,t){return{role:"assistant",id:e,author:"agent",type:"tool",tool_name:t.tool_name||"",tool_args:t.tool_args||{},result:t,isStreaming:!1}}(e,t)}createToolCallAndResult(e,t,s,n){return[this.createToolCall(e,t,s),this.createToolResult(e,n)]}trackPendingResult(e,t,s,n){return this.pendingToolResults.set(e,{name:t,arguments:s,result:n}),this}getPendingResultMessages(){const e=[];return this.pendingToolResults.forEach((t,s)=>{const[n,r]=this.createToolCallAndResult(s,t.name,t.arguments,t.result);e.push(n,r)}),e}clearPendingResults(){return this.pendingToolResults.clear(),this}hasPendingResults(){return this.pendingToolResults.size>0}getPendingResultCount(){return this.pendingToolResults.size}createUserDecisionMessage(e,t){const s="accepted"===e?"accepted":"rejected",n=t.tool_type||"tool";let r=`User ${s} the ${n} suggestion.`;return"accepted"===e&&(r+=this.getAcceptanceDetails(n,t)),m(r)}getAcceptanceDetails(e,t){switch(e){case"edit_post":return` The text "${t.search_pattern}" was changed to "${t.replacement_text}" in the post.`;case"insert_content":return" New content was added to the post.";case"write_to_post":return" The post content was completely replaced.";default:return""}}debug(){console.log("ToolHistory Debug:",{pendingToolResults:this.pendingToolResults.size,pendingTools:Array.from(this.pendingToolResults.keys())})}}class _{constructor(e=[]){this.messages=this.validateInitialMessages(e),this.toolHistory=new y}validateInitialMessages(e){return h(e)}getMessages(){return[...this.messages]}getOpenAIMessages(){return h(this.messages.filter(e=>"user"!==e.role||!e.content||!e.content.startsWith("User accepted the")&&!e.content.startsWith("User rejected the")).map(e=>{const{isStreaming:t,...s}=e;return s}))}getUIMessages(){return this.messages.filter(e=>"text"===e.type||"tool"===e.type)}addUserMessage(e){return this.messages.push(m(e)),this}addAssistantMessage(e,t=!1){return this.messages.push(function(e,t=!1){return{role:"assistant",content:e,type:"text",author:"agent",isStreaming:t}}(e,t)),this}updateMessageContent(e,t){return this.messages[e]&&(this.messages[e].content=t),this}updateMessageStreamingStatus(e,t){return this.messages[e]&&(this.messages[e].isStreaming=t),this}addToolCall(e,t,s){return this.messages.some(t=>"tool"===t.type&&t.id===e)||this.messages.push({role:"assistant",id:e,author:"agent",type:"tool",tool_name:t,tool_args:s,result:null,isStreaming:!0}),this}updateToolCall(e,t){const s=this.messages.find(t=>"tool"===t.type&&t.id===e);return s&&(s.result=t,s.isStreaming=!1),this}addToolResult(e,t){const s=this.toolHistory.createToolResult(e,t);return this.messages.push(s),this}addToolCallAndResult(e,t,s,n){const[r,a]=this.toolHistory.createToolCallAndResult(e,t,s,n);return this.messages.push(r,a),this}trackPendingToolResult(e,t,s,n){return this.toolHistory.trackPendingResult(e,t,s,n),this}flushPendingToolResults(){const e=this.toolHistory.getPendingResultMessages();return this.messages.push(...e),this.toolHistory.clearPendingResults(),this}addUserDecision(e,t){const s=this.toolHistory.createUserDecisionMessage(e,t);return this.messages.push(s),this}clear(){return this.messages=[],this.toolHistory.clearPendingResults(),this}getLastMessage(){return this.messages[this.messages.length-1]||null}getMessageCount(){return this.messages.length}setMessages(e){return this.messages=h(e),this}debug(){console.log("ChatHistory Debug:",{messageCount:this.messages.length,messages:this.messages}),this.toolHistory.debug()}}const S=window.wp.blocks;function b(e){var t,s,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e)if(Array.isArray(e)){var r=e.length;for(t=0;t<r;t++)e[t]&&(s=b(e[t]))&&(n&&(n+=" "),n+=s)}else for(s in e)e[s]&&(n&&(n+=" "),n+=s);return n}const E=function(){for(var e,t,s=0,n="",r=arguments.length;s<r;s++)(e=arguments[s])&&(t=b(e))&&(n&&(n+=" "),n+=t);return n},w=window.wp.components;var k=s(848);function A({scope:e,...t}){return(0,k.jsx)(w.Fill,{name:`PinnedItems/${e}`,...t})}A.Slot=function({scope:e,className:t,...s}){return(0,k.jsx)(w.Slot,{name:`PinnedItems/${e}`,...s,children:e=>e?.length>0&&(0,k.jsx)("div",{className:E(t,"interface-pinned-items"),children:e})})};const v=A,C=window.wp.deprecated;var I=s.n(C);const M=window.wp.preferences;function D(e){return["core/edit-post","core/edit-site"].includes(e)?(I()(`${e} interface scope`,{alternative:"core interface scope",hint:"core/edit-post and core/edit-site are merging.",version:"6.6"}),"core"):e}function R(e,t){return"core"===e&&"edit-site/template"===t?(I()("edit-site/template sidebar",{alternative:"edit-post/document",version:"6.6"}),"edit-post/document"):"core"===e&&"edit-site/block-inspector"===t?(I()("edit-site/block-inspector sidebar",{alternative:"edit-post/block",version:"6.6"}),"edit-post/block"):t}const P=(e,t)=>({type:"SET_DEFAULT_COMPLEMENTARY_AREA",scope:e=D(e),area:t=R(e,t)}),B=(e,t)=>({registry:s,dispatch:n})=>{t&&(e=D(e),t=R(e,t),s.select(M.store).get(e,"isComplementaryAreaVisible")||s.dispatch(M.store).set(e,"isComplementaryAreaVisible",!0),n({type:"ENABLE_COMPLEMENTARY_AREA",scope:e,area:t}))},T=e=>({registry:t})=>{e=D(e),t.select(M.store).get(e,"isComplementaryAreaVisible")&&t.dispatch(M.store).set(e,"isComplementaryAreaVisible",!1)},U=(e,t)=>({registry:s})=>{if(!t)return;e=D(e),t=R(e,t);const n=s.select(M.store).get(e,"pinnedItems");!0!==n?.[t]&&s.dispatch(M.store).set(e,"pinnedItems",{...n,[t]:!0})},N=(e,t)=>({registry:s})=>{if(!t)return;e=D(e),t=R(e,t);const n=s.select(M.store).get(e,"pinnedItems");s.dispatch(M.store).set(e,"pinnedItems",{...n,[t]:!1})};function x(e,t){return function({registry:s}){I()("dispatch( 'core/interface' ).toggleFeature",{since:"6.0",alternative:"dispatch( 'core/preferences' ).toggle"}),s.dispatch(M.store).toggle(e,t)}}function j(e,t,s){return function({registry:n}){I()("dispatch( 'core/interface' ).setFeatureValue",{since:"6.0",alternative:"dispatch( 'core/preferences' ).set"}),n.dispatch(M.store).set(e,t,!!s)}}function O(e,t){return function({registry:s}){I()("dispatch( 'core/interface' ).setFeatureDefaults",{since:"6.0",alternative:"dispatch( 'core/preferences' ).setDefaults"}),s.dispatch(M.store).setDefaults(e,t)}}function H(e){return{type:"OPEN_MODAL",name:e}}function L(){return{type:"CLOSE_MODAL"}}const F=(0,u.createRegistrySelector)(e=>(t,s)=>{s=D(s);const n=e(M.store).get(s,"isComplementaryAreaVisible");if(void 0!==n)return!1===n?null:t?.complementaryAreas?.[s]}),W=(0,u.createRegistrySelector)(e=>(t,s)=>{s=D(s);const n=e(M.store).get(s,"isComplementaryAreaVisible"),r=t?.complementaryAreas?.[s];return n&&void 0===r}),V=(0,u.createRegistrySelector)(e=>(t,s,n)=>{var r;n=R(s=D(s),n);const a=e(M.store).get(s,"pinnedItems");return null===(r=a?.[n])||void 0===r||r}),$=(0,u.createRegistrySelector)(e=>(t,s,n)=>(I()("select( 'core/interface' ).isFeatureActive( scope, featureName )",{since:"6.0",alternative:"select( 'core/preferences' ).get( scope, featureName )"}),!!e(M.store).get(s,n)));function z(e,t){return e.activeModal===t}const J=(0,u.combineReducers)({complementaryAreas:function(e={},t){switch(t.type){case"SET_DEFAULT_COMPLEMENTARY_AREA":{const{scope:s,area:n}=t;return e[s]?e:{...e,[s]:n}}case"ENABLE_COMPLEMENTARY_AREA":{const{scope:s,area:n}=t;return{...e,[s]:n}}}return e},activeModal:function(e=null,t){switch(t.type){case"OPEN_MODAL":return t.name;case"CLOSE_MODAL":return null}return e}}),Y=(0,u.createReduxStore)("core/interface",{reducer:J,actions:n,selectors:r});(0,u.register)(Y);class G{static findAllDiffBlocks(){const{getBlocks:e}=wp.data.select("core/block-editor");return e().filter(e=>"wordsurf/diff"===e.name)}static findDiffBlocksByDiffId(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.diffId===e)}static findDiffBlocksByToolCallId(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.toolCallId===e)}static hasDiffBlocks(){return this.findAllDiffBlocks().length>0}static getDiffBlockCount(){return this.findAllDiffBlocks().length}static findDiffBlockByClientId(e){return this.findAllDiffBlocks().find(t=>t.clientId===e)||null}static findDiffBlocksByStatus(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.status===e)}static findPendingDiffBlocks(){return this.findDiffBlocksByStatus("pending")}static getOriginalBlockContent(e){return e.attributes?.originalBlockContent||""}static getOriginalBlockType(e){return e.attributes?.originalBlockType||"core/paragraph"}static isDiffBlock(e){return"wordsurf/diff"===e?.name}}const K=({diffContext:e,onAccept:t,onReject:s})=>{const{diffs:n}=e,[r,o]=(0,a.useState)(null),[i,l]=(0,a.useState)(!1),c=(0,a.useRef)(new Set),{blocks:d,postContent:g}=(0,u.useSelect)(e=>({blocks:e("core/block-editor").getBlocks(),postContent:e("core/editor").getEditedPostAttribute("content")})),{lockPostSaving:f,unlockPostSaving:p}=(0,u.useDispatch)("core/editor"),{updateBlockAttributes:h,insertBlocks:m,replaceBlock:y,resetBlocks:_}=(0,u.useDispatch)("core/block-editor");return(0,a.useEffect)(()=>{if(n.length>0&&!i){const e=n[0],t=e.diff_id||e.tool_call_id;if(c.current.has(t))return;console.log("InlineDiffManager: Processing new diff:",e),console.log("InlineDiffManager: Diff has target_blocks:",!!e.target_blocks),e.target_blocks&&console.log("InlineDiffManager: Number of target blocks:",e.target_blocks.length);try{if(o([...d]),f("wordsurf-diff-preview"),l(!0),c.current.add(t),e.target_blocks&&e.target_blocks.length>0){console.log("InlineDiffManager: Using granular target blocks approach");try{e.target_blocks.forEach((e,t)=>{const{block_index:s,diff_wrapper_block:n}=e,r=wp.blocks.parse(n)[0];if(r&&d[s]){const e=d[s];console.log(`InlineDiffManager: Replacing block ${s} with diff wrapper`),y(e.clientId,r)}else console.error(`InlineDiffManager: Could not process target block ${s}`)}),console.log("InlineDiffManager: Successfully processed",e.target_blocks.length,"target blocks granularly")}catch(e){console.error("InlineDiffManager: Error processing target blocks:",e),l(!1),c.current.delete(t)}}else if(e.diff_block_content){console.log("InlineDiffManager: Using legacy diff_block_content approach");const s=wp.blocks.parse(e.diff_block_content);s.length>0?(_(s),console.log("InlineDiffManager: Successfully used legacy approach")):(l(!1),c.current.delete(t))}else console.error("InlineDiffManager: No target_blocks or diff_block_content provided"),l(!1),c.current.delete(t)}catch(e){console.error("InlineDiffManager: Error processing diff:",e),l(!1),c.current.delete(t)}}},[n.length,i]),(0,a.createElement)(w.Fill,{name:"PluginHeader"},i&&(0,a.createElement)(v,null,(0,a.createElement)("div",{style:{display:"flex",gap:"8px",alignItems:"center",color:"#1e1e1e",backgroundColor:"#fff",padding:"4px 8px",borderRadius:"4px",border:"1px solid #ddd"}},(0,a.createElement)("strong",null,"Wordsurf Change Preview:"),(0,a.createElement)(w.Button,{isPrimary:!0,onClick:()=>{const e=n[0];console.log("InlineDiffManager: Header accept clicked for diff block"),p("wordsurf-diff-preview"),o(null),l(!1),c.current.delete(e.tool_call_id),t(e)}},"Accept Changes"),(0,a.createElement)(w.Button,{isSecondary:!0,onClick:()=>{const e=n[0];console.log("InlineDiffManager: Header reject clicked for diff block"),p("wordsurf-diff-preview"),o(null),l(!1),c.current.delete(e.tool_call_id),s(e)}},"Reject"))))},q=({name:e,args:t,result:s,status:n})=>{let r=t;if("string"==typeof t)try{r=JSON.parse(t)}catch(e){}return(0,a.createElement)("div",{className:"tool-call"},(0,a.createElement)("div",{className:"tool-header"},"in_progress"===n?(0,a.createElement)("div",{className:"spinner"}):!0===s?.success?(0,a.createElement)("div",{className:"icon"},"✅"):!1===s?.success?(0,a.createElement)("div",{className:"icon"},"❌"):(0,a.createElement)("div",{className:"icon"},"⚙️"),(0,a.createElement)("span",{className:"tool-name"},e)))},Q=({message:e})=>"tool"===e.type?(0,a.createElement)("div",{className:`chat-message ${e.author}`},(0,a.createElement)(q,{name:e.tool_name,args:e.tool_args,result:e.result,status:e.result?"completed":"in_progress"})):(0,a.createElement)("div",{className:`chat-message ${e.author}`},(0,a.createElement)("div",{className:"chat-bubble"},e.content,e.isStreaming&&(0,a.createElement)("span",{className:"typing-indicator"},(0,a.createElement)("span",null),(0,a.createElement)("span",null),(0,a.createElement)("span",null)))),X=({value:e,onChange:t,onSend:s,disabled:n=!1,placeholder:r="Ask me to edit, write, or brainstorm..."})=>(0,a.createElement)("div",{className:"wordsurf-input-area"},(0,a.createElement)("textarea",{value:e,onChange:t,placeholder:r,disabled:n,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),s())}}),(0,a.createElement)("button",{onClick:s,disabled:n||!e.trim()},"Send")),Z=({diffs:e,onAcceptAll:t,onRejectAll:s})=>e&&0!==e.length?(console.log("PendingChanges: Rendering diff control UI for",e.length,"diffs"),(0,a.createElement)("div",{className:"wordsurf-pending-changes"},(0,a.createElement)("div",{className:"pending-changes-content"},(0,a.createElement)("div",{className:"pending-changes-actions"},(0,a.createElement)("button",{className:"button button-primary",onClick:t,style:{marginRight:"8px"}},"Accept All"),(0,a.createElement)("button",{className:"button button-secondary",onClick:s},"Reject All"))))):null,ee=({messages:e,isWaiting:t,inputValue:s,onInputChange:n,onSend:r,isStreaming:i,hasStreamingAssistant:l,pendingDiffs:c,onAcceptAllChanges:d,onRejectAllChanges:u})=>{const g=o().useRef(null);return o().useEffect(()=>{g.current&&(g.current.scrollTop=g.current.scrollHeight)},[e]),(0,a.createElement)("div",{className:"wordsurf-sidebar-content"},(0,a.createElement)("div",{className:"wordsurf-chat-window",ref:g},e.map((e,t)=>(0,a.createElement)(Q,{key:t,message:e})),t&&!l&&(0,a.createElement)("div",{className:"chat-message agent"},(0,a.createElement)("div",{className:"chat-bubble"},"Thinking...",(0,a.createElement)("span",{className:"typing-indicator"},(0,a.createElement)("span",null),(0,a.createElement)("span",null),(0,a.createElement)("span",null)))),(0,a.createElement)(Z,{diffs:c,onAcceptAll:d,onRejectAll:u})),(0,a.createElement)(X,{value:s,onChange:n,onSend:r,disabled:i}))};class te{static async handleAccept(e,t,s,n){const{toolCallId:r,diffId:a,originalContent:o,replacementContent:i,originalBlockContent:l,originalBlockType:c,searchPattern:d}=e;try{let e=l||"";if(e&&o&&i){const t=d||o;e.includes(t)&&(e=e.replace(t,i))}return s(t,(0,S.createBlock)(c||"core/paragraph",{content:e})),await te.sendUserDecision("accepted",{tool_call_id:r,diff_id:a,post_id:n}),{success:!0}}catch(e){throw console.error("Error accepting diff:",e),e}}static async handleReject(e,t,s,n){const{toolCallId:r,diffId:a,originalBlockContent:o,originalBlockType:i}=e;try{return s(t,(0,S.createBlock)(i||"core/paragraph",{content:o||""})),await te.sendUserDecision("rejected",{tool_call_id:r,diff_id:a,post_id:n}),{success:!0}}catch(e){throw console.error("Error rejecting diff:",e),e}}static async sendUserDecision(e,t){const s=new FormData;s.append("action","wordsurf_user_feedback"),s.append("nonce",wp.ajax.settings.nonce),s.append("user_action",e),s.append("tool_call_id",t.tool_call_id),s.append("diff_id",t.diff_id),s.append("post_id",t.post_id);const n=await fetch(wp.ajax.settings.url,{method:"POST",body:s});if(!n.ok)throw new Error("Failed to send user decision");return n}static createActionHandlers(e,t,s,n,r,a){return{handleAccept:async()=>{r(!0);try{a({status:"accepted"}),await te.handleAccept(e,t,s,n)}catch(e){throw a({status:"pending"}),e}finally{r(!1)}},handleReject:async()=>{r(!0);try{a({status:"rejected"}),await te.handleReject(e,t,s,n)}catch(e){throw a({status:"pending"}),e}finally{r(!1)}}}}}class se{static async acceptAll(){const{replaceBlock:e}=wp.data.dispatch("core/block-editor"),{getCurrentPostId:t}=wp.data.select("core/editor"),s=G.findAllDiffBlocks(),n=t();console.log("HandleAcceptAll: Processing",s.length,"diff blocks");for(const t of s)try{await te.handleAccept(t.attributes,t.clientId,e,n),console.log("HandleAcceptAll: Accepted diff block",t.attributes.diffId)}catch(e){console.error("HandleAcceptAll: Error accepting diff block",t.attributes.diffId,e)}return s.length}static async rejectAll(){const{replaceBlock:e}=wp.data.dispatch("core/block-editor"),{getCurrentPostId:t}=wp.data.select("core/editor"),s=G.findAllDiffBlocks(),n=t();console.log("HandleAcceptAll: Rejecting",s.length,"diff blocks");for(const t of s)try{await te.handleReject(t.attributes,t.clientId,e,n),console.log("HandleAcceptAll: Rejected diff block",t.attributes.diffId)}catch(e){console.error("HandleAcceptAll: Error rejecting diff block",t.attributes.diffId,e)}return s.length}}const ne="wordsurf",re=(0,c.__)("Wordsurf","wordsurf"),ae=()=>(0,a.createElement)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},(0,a.createElement)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8 8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z",fill:"currentColor"}),(0,a.createElement)("path",{d:"M12 12m-6 0a6 6 0 1 0 12 0a6 6 0 1 0 -12 0",fill:"currentColor",fillOpacity:"0.3"}));wp.plugins.getPlugin(ne)||(0,i.registerPlugin)(ne,{render:()=>{const[e,t]=(0,d.useState)({originalContent:"",diffs:[]});(0,d.useEffect)(()=>{e.diffs.length>0&&console.log("WordsurfPlugin: diffContext has diffs:",e)},[e.diffs.length]);const s=(0,d.useRef)(new _([])),n=(0,u.useSelect)(e=>{const{getCurrentPostId:t,getEditedPostAttribute:s}=e("core/editor"),{getBlocks:n}=e("core/block-editor");return{postId:t(),title:s("title"),content:s("content"),status:s("status"),type:s("type"),blocks:n()}});(0,d.useEffect)(()=>{e.diffs.length>0&&n.blocks&&(G.hasDiffBlocks()||(console.log("WordsurfPlugin: No diff blocks remaining in editor - resetting chat state"),t(e=>({...e,diffs:[]}))))},[n.blocks,e.diffs.length]);const r=(0,d.useCallback)(e=>{console.log("WordsurfPlugin: Received diff data:",e),console.log("WordsurfPlugin: Has diff_block_content:",!!e.diff_block_content),t(t=>({...t,diffs:[...t.diffs,e]}))},[]),o=(({postId:e,onDiffReceived:t,onUserDecision:s,chatHistory:n})=>{const r=(0,a.useRef)(null);r.current||(r.current=new f(n.current,t));const o=r.current,[i,l]=(0,a.useState)(o.getState()),[c,d]=(0,a.useState)(""),u=(0,a.useCallback)(()=>{l(o.getState())},[o]);(0,a.useEffect)(()=>()=>{o.cleanup()},[o]),(0,a.useEffect)(()=>{o.setInputValue(c)},[c,o]);const p=(0,a.useCallback)(()=>{const t=c.trim();!t||o.isStreaming||o.hasSentMessage||o.currentEventSource||(n.current.addUserMessage(t),u(),d(""),o.startStream(n.current.getOpenAIMessages(),e,g,u,u,u))},[c,o,n,e,u]),h=(0,a.useCallback)((e,t)=>{n.current.addUserDecision(e,t),u();const s=new FormData;s.append("action","wordsurf_tool_action"),s.append("action_type",e),s.append("tool_call_id",t.tool_call_id),s.append("tool_data",JSON.stringify(t)),s.append("nonce",window.wordsurfData?.nonce||""),fetch(window.wordsurfData.ajax_url,{method:"POST",body:s}).then(e=>e.json()).then(e=>{e.success?console.log("Tool action processed successfully:",e):console.error("Tool action failed:",e)}).catch(e=>{console.error("Error processing tool action:",e)})},[n,u]);return{isStreaming:i.isStreaming,isWaiting:i.isWaiting,inputValue:c,setInputValue:d,uiMessages:i.uiMessages,handleSend:p,updateUIMessages:u,recordUserDecision:h,hasStreamingAssistant:i.hasStreamingAssistant}})({postId:n.postId,onDiffReceived:r,chatHistory:s}),i=(0,d.useCallback)(e=>{o.recordUserDecision("accepted",e),t(t=>({...t,diffs:t.diffs.filter(t=>t.tool_call_id!==e.tool_call_id)}))},[o]),c=(0,d.useCallback)(e=>{o.recordUserDecision("rejected",e),t(t=>({...t,diffs:t.diffs.filter(t=>t.tool_call_id!==e.tool_call_id)}))},[o]),p=(0,d.useCallback)(async()=>{console.log("WordsurfPlugin: Accept all clicked");try{const s=await se.acceptAll();console.log("WordsurfPlugin: Accepted",s,"diff blocks"),e.diffs.forEach(e=>{o.recordUserDecision("accepted",e)}),t(e=>({...e,diffs:[]}))}catch(e){console.error("WordsurfPlugin: Error accepting all changes:",e)}},[e.diffs,o]),h=(0,d.useCallback)(async()=>{console.log("WordsurfPlugin: Reject all clicked");try{const s=await se.rejectAll();console.log("WordsurfPlugin: Rejected",s,"diff blocks"),e.diffs.forEach(e=>{o.recordUserDecision("rejected",e)}),t(e=>({...e,diffs:[]}))}catch(e){console.error("WordsurfPlugin: Error rejecting all changes:",e)}},[e.diffs,o]),m=(0,d.useCallback)(()=>{t(e=>({...e,originalContent:n.content,diffs:[]})),o.handleSend()},[n.content,o,t]);return(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.PluginSidebarMoreMenuItem,{target:ne},re),(0,a.createElement)(l.PluginSidebar,{name:ne,title:re,icon:(0,a.createElement)(ae,null)},(0,a.createElement)(ee,{messages:o.uiMessages,isWaiting:o.isWaiting,inputValue:o.inputValue,onInputChange:e=>o.setInputValue(e.target.value),onSend:m,isStreaming:o.isStreaming,hasStreamingAssistant:o.hasStreamingAssistant,pendingDiffs:e.diffs,onAcceptAllChanges:p,onRejectAllChanges:h})),(0,a.createElement)(K,{diffContext:e,onAccept:i,onReject:c,key:`diff-manager-${e.diffs.length}`}))}})})();