(()=>{"use strict";var e={20:(e,t,n)=>{var s=n(609),o=Symbol.for("react.element"),r=(Symbol.for("react.fragment"),Object.prototype.hasOwnProperty),a=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};t.jsx=function(e,t,n){var s,l={},c=null,d=null;for(s in void 0!==n&&(c=""+n),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(d=t.ref),t)r.call(t,s)&&!i.hasOwnProperty(s)&&(l[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===l[s]&&(l[s]=t[s]);return{$$typeof:o,type:e,key:c,ref:d,props:l,_owner:a.current}}},609:e=>{e.exports=window.React},848:(e,t,n)=>{e.exports=n(20)}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};n.r(s),n.d(s,{closeModal:()=>O,disableComplementaryArea:()=>B,enableComplementaryArea:()=>R,openModal:()=>j,pinItem:()=>P,setDefaultComplementaryArea:()=>M,setFeatureDefaults:()=>N,setFeatureValue:()=>U,toggleFeature:()=>x,unpinItem:()=>T});var o={};n.r(o),n.d(o,{getActiveComplementaryArea:()=>W,isComplementaryAreaLoading:()=>H,isFeatureActive:()=>L,isItemPinned:()=>F,isModalActive:()=>$});var r=n(609),a=n.n(r);const i=window.wp.plugins,l=window.wp.editor,c=window.wp.i18n,d=window.wp.element,u=window.wp.data;function g(e,t=null,n,s,o){const r=new URLSearchParams({action:"wordsurf_stream_chat",messages:JSON.stringify(e),post_id:t||"",context_window:JSON.stringify({}),nonce:window.wordsurfData?.nonce||""}),a=new EventSource(`${window.wordsurfData.ajax_url}?${r.toString()}`);let i=!1,l=!1,c=!1;return a.onmessage=function(e){console.log("🚀 DEFAULT MESSAGE EVENT:",e.type,e.data)},a.onopen=function(e){console.log("🟢 EventSource connection opened")},a.onerror=function(e){console.log("🔴 EventSource error event:",e,"readyState:",a.readyState)},a.addEventListener("response.output_text.delta",e=>{try{const t=JSON.parse(e.data);t.delta&&n({type:"text",data:{content:t.delta}})}catch(t){console.error("Failed to parse text delta:",e.data,t)}}),a.addEventListener("response.output_item.added",e=>{try{const t=JSON.parse(e.data);t.item&&"function_call"===t.item.type&&(c=!0,n({type:"tool_start",data:t.item}))}catch(t){console.error("Failed to parse tool start:",e.data,t)}}),a.addEventListener("tool_result",e=>{console.log("🔧 TOOL_RESULT EVENT RECEIVED:",e.data),console.log("🔧 Event object:",e),console.log("🔧 EventSource readyState:",a.readyState);try{const t=JSON.parse(e.data);console.log("🔧 Parsed tool result:",t),console.log("🔧 About to call onEvent with:",{type:"tool_result",data:t}),n({type:"tool_result",data:t}),l=!0,a.close(),s&&s()}catch(t){console.error("Failed to parse tool result:",e.data,t)}}),a.addEventListener("response.completed",e=>{i=!0;try{const t=JSON.parse(e.data);console.log("StreamApi: Stream completed by API.",t),n({type:"stream_end",data:t.response}),c?console.log("StreamApi: Stream completed, keeping connection open for tool results"):(console.log("StreamApi: Stream completed, no tools detected, closing immediately"),l=!0,a.close(),s&&s())}catch(t){console.error("Failed to parse response.completed event:",e.data,t),n({type:"stream_end",data:{status:"completed"}}),l||(console.log("StreamApi: Parse error recovery - closing connection immediately"),l=!0,a.close(),s&&s())}}),a.addEventListener("message",e=>{e.type.startsWith("response.")||console.log("StreamApi: Received unexpected message event:",e)}),a.addEventListener("error",e=>{l||(l=!0,a.close()),i||a.readyState===EventSource.CLOSED||(console.error("StreamApi: EventSource error:",e),o&&o(e))}),a}let f=!1;class p{constructor(e,t){this.chatHistory=e,this.onDiffReceived=t,this.isStreaming=!1,this.isWaiting=!1,this.streamingBuffer="",this.accumulatedContent="",this.hasSentMessage=!1,this.currentEventSource=null,this.animationFrameId=null,this.onUIUpdate=null,this.streamingMessageIndex=-1,this.currentResponseId=null}startStream(e,t,n,s,o,r){this.isStreaming||this.hasSentMessage||this.currentEventSource||f?console.log("ChatStreamSession: Cannot start stream - already active",{isStreaming:this.isStreaming,hasSentMessage:this.hasSentMessage,hasEventSource:!!this.currentEventSource,globalActive:f}):(this.currentEventSource&&(console.log("ChatStreamSession: Closing existing EventSource before creating new one"),this.currentEventSource.close(),this.currentEventSource=null),f=!0,this.isStreaming=!0,this.isWaiting=!0,this.hasSentMessage=!0,this.streamingBuffer="",this.accumulatedContent="",this.onUIUpdate=r,this.streamingMessageIndex=-1,console.log("ChatStreamSession: Creating new EventSource for chat stream"),this.currentEventSource=n(e,t,e=>this.handleEvent(e),()=>this.handleComplete(s),e=>this.handleError(o,e)),this.onUIUpdate&&this.onUIUpdate())}handleEvent(e){if(e.type&&e.data){switch(e.type){case"tool_start":this.isWaiting=!1,this.flushStreamingBuffer(),this.chatHistory.addToolCall(e.data.call_id,e.data.name,e.data.arguments),this.finalizeStreamingMessage();break;case"text":this.isWaiting=!1,null!=e.data.content&&(this.streamingBuffer+=e.data.content,this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>{this.flushStreamingBuffer(),this.onUIUpdate&&this.onUIUpdate()})));break;case"stream_end":this.finalizeStreamingMessage();break;case"tool_result":this.isWaiting=!1;const{tool_call_id:t,tool_name:n,result:s,response_id:o}=e.data;o&&(this.currentResponseId=o,console.log("ChatStreamSession: Stored response ID for continuation:",o)),console.log("ChatStreamSession: Received tool_result:",{tool_call_id:t,tool_name:n,result:s,response_id:o,preview:s?.preview,hasCallback:!!this.onDiffReceived}),console.log("ChatStreamSession: DEBUG - Full event.data structure:",e.data),console.log("ChatStreamSession: DEBUG - result object keys:",s?Object.keys(s):"result is null/undefined"),console.log("ChatStreamSession: DEBUG - result.preview value and type:",s?.preview,typeof s?.preview),this.chatHistory.updateToolCall(t,{success:s.success,completed:!0,...s});const r=s.result||s,a=r.target_blocks||r.original_content||r.diff_block_content;a&&this.onDiffReceived?(console.log("ChatStreamSession: CALLING onDiffReceived with diff data"),console.log("ChatStreamSession: Full result data:",s),console.log("ChatStreamSession: Actual tool result:",r),this.onDiffReceived({tool_call_id:t,original_content:r.original_content,new_content:r.new_content,search_pattern:r.search_pattern,replacement_text:r.replacement_text,diff_block_content:r.diff_block_content,target_blocks:r.target_blocks,diff_id:r.diff_id,tool_name:n,message:r.message})):console.log("ChatStreamSession: NOT calling onDiffReceived because:",{hasDiffData:!!a,hasCallback:!!this.onDiffReceived,hasTargetBlocks:!!r.target_blocks,hasOriginalContent:!!r.original_content,hasDiffBlockContent:!!r.diff_block_content,resultKeys:s?Object.keys(s):"no result",actualToolResultKeys:r?Object.keys(r):"no actualToolResult"})}this.onUIUpdate&&this.onUIUpdate()}}flushStreamingBuffer(){this.streamingBuffer.length>0&&(this.accumulatedContent+=this.streamingBuffer,-1===this.streamingMessageIndex?(this.chatHistory.addAssistantMessage(this.accumulatedContent,!0),this.streamingMessageIndex=this.chatHistory.getMessageCount()-1):this.chatHistory.updateMessageContent(this.streamingMessageIndex,this.accumulatedContent),this.streamingBuffer=""),this.animationFrameId=null}finalizeStreamingMessage(){-1!==this.streamingMessageIndex&&this.chatHistory.updateMessageStreamingStatus(this.streamingMessageIndex,!1)}handleComplete(e){this.streamingBuffer.length>0&&this.flushStreamingBuffer(),this.finalizeStreamingMessage(),this.isStreaming=!1,this.isWaiting=!1,this.hasSentMessage=!1,this.currentEventSource=null,this.streamingMessageIndex=-1,this.accumulatedContent="",f=!1,e&&e(),this.onUIUpdate&&this.onUIUpdate()}handleError(e,t){this.streamingBuffer.length>0?this.flushStreamingBuffer():0===this.accumulatedContent.length&&this.chatHistory.addAssistantMessage("Sorry, there was an error.",!1),this.finalizeStreamingMessage(),this.isStreaming=!1,this.isWaiting=!1,this.hasSentMessage=!1,this.currentEventSource=null,this.streamingMessageIndex=-1,this.accumulatedContent="",f=!1,e&&e(t),this.onUIUpdate&&this.onUIUpdate()}getState(){return{isStreaming:this.isStreaming,isWaiting:this.isWaiting,uiMessages:this.chatHistory.getUIMessages(),hasStreamingAssistant:this.hasStreamingAssistantMessage()}}hasStreamingAssistantMessage(){return this.chatHistory.getUIMessages().some(e=>"assistant"===e.role&&e.isStreaming)}setInputValue(e){this.inputValue=e}getInputValue(){return this.inputValue||""}getCurrentResponseId(){return this.currentResponseId}forceCleanupConnection(){console.log("ChatStreamSession: Force cleaning up connection"),this.currentEventSource&&(this.currentEventSource.close(),this.currentEventSource=null),this.isStreaming=!1,this.isWaiting=!1,this.hasSentMessage=!1,f=!1,this.onUIUpdate&&this.onUIUpdate()}cleanup(){console.log("ChatStreamSession: Cleaning up session"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.currentEventSource&&(console.log("ChatStreamSession: Closing EventSource during cleanup"),this.currentEventSource.close(),this.currentEventSource=null),this.isStreaming=!1,this.isWaiting=!1,this.hasSentMessage=!1,this.streamingBuffer="",this.accumulatedContent="",this.streamingMessageIndex=-1,this.currentResponseId=null,f=!1}}let h=!1;class m{constructor(){this.pendingToolResults=new Map}createToolCall(e,t,n){return((e,t,n)=>({role:"assistant",tool_calls:[{id:e,type:"function",function:{name:t,arguments:"string"==typeof n?n:JSON.stringify(n)}}]}))(e,t,n)}createToolResult(e,t){return((e,t)=>({role:"tool",tool_call_id:e,content:"string"==typeof t?t:JSON.stringify(t)}))(e,t)}createToolCallAndResult(e,t,n,s){return[this.createToolCall(e,t,n),this.createToolResult(e,s)]}trackPendingResult(e,t,n,s){return this.pendingToolResults.set(e,{name:t,arguments:n,result:s}),this}getPendingResultMessages(){const e=[];return this.pendingToolResults.forEach((t,n)=>{const[s,o]=this.createToolCallAndResult(n,t.name,t.arguments,t.result);e.push(s,o)}),e}clearPendingResults(){return this.pendingToolResults.clear(),this}hasPendingResults(){return this.pendingToolResults.size>0}getPendingResultCount(){return this.pendingToolResults.size}createUserDecisionMessage(e,t){return{role:"user",content:("accepted"===e?"accepted":"rejected")+" change"}}getAcceptanceDetails(e,t){switch(e){case"edit_post":return` The text "${t.search_pattern}" was changed to "${t.replacement_text}" in the post.`;case"insert_content":return" New content was added to the post.";case"write_to_post":return" The post content was completely replaced.";default:return""}}debug(){console.log("ToolHistory Debug:",{pendingToolResults:this.pendingToolResults.size,pendingTools:Array.from(this.pendingToolResults.keys())})}}class S{constructor(e=[]){this.messages=this.validateInitialMessages(e),this.toolHistory=new m}validateInitialMessages(e){return Array.isArray(e)?e:[]}getMessages(){return[...this.messages]}getOpenAIMessages(){return this.messages}getUIMessages(){return this.messages}addUserMessage(e){return this.messages.push((e=>({role:"user",content:e}))(e)),this}addAssistantMessage(e,t=!1){return this.messages.push((e=>({role:"assistant",content:e}))(e)),this}updateMessageContent(e,t){return this.messages[e]&&(this.messages[e].content=t),this}updateMessageStreamingStatus(e,t){return this.messages[e]&&(this.messages[e].isStreaming=t),this}addToolCall(e,t,n){return this.messages.some(t=>"tool"===t.type&&t.id===e)||this.messages.push({role:"assistant",id:e,author:"agent",type:"tool",tool_name:t,tool_args:n,result:null,isStreaming:!0}),this}updateToolCall(e,t){const n=this.messages.find(t=>"tool"===t.type&&t.id===e);return n&&(n.result=t,n.isStreaming=!1),this}addToolResult(e,t){const n=this.toolHistory.createToolResult(e,t);return this.messages.push(n),this}addToolCallAndResult(e,t,n,s){const[o,r]=this.toolHistory.createToolCallAndResult(e,t,n,s);return this.messages.push(o,r),this}trackPendingToolResult(e,t,n,s){return this.toolHistory.trackPendingResult(e,t,n,s),this}flushPendingToolResults(){const e=this.toolHistory.getPendingResultMessages();return this.messages.push(...e),this.toolHistory.clearPendingResults(),this}addUserDecision(e,t){const n=this.toolHistory.createUserDecisionMessage(e,t);return this.messages.push(n),this}clear(){return this.messages=[],this.toolHistory.clearPendingResults(),this}getLastMessage(){return this.messages[this.messages.length-1]||null}getMessageCount(){return this.messages.length}setMessages(e){return this.messages=Array.isArray(e)?e:[],this}debug(){console.log("ChatHistory Debug:",{messageCount:this.messages.length,messages:this.messages}),this.toolHistory.debug()}}function y(e){var t,n,s="";if("string"==typeof e||"number"==typeof e)s+=e;else if("object"==typeof e)if(Array.isArray(e)){var o=e.length;for(t=0;t<o;t++)e[t]&&(n=y(e[t]))&&(s&&(s+=" "),s+=n)}else for(n in e)e[n]&&(s&&(s+=" "),s+=n);return s}const _=function(){for(var e,t,n=0,s="",o=arguments.length;n<o;n++)(e=arguments[n])&&(t=y(e))&&(s&&(s+=" "),s+=t);return s},v=window.wp.components;var b=n(848);function E({scope:e,...t}){return(0,b.jsx)(v.Fill,{name:`PinnedItems/${e}`,...t})}E.Slot=function({scope:e,className:t,...n}){return(0,b.jsx)(v.Slot,{name:`PinnedItems/${e}`,...n,children:e=>e?.length>0&&(0,b.jsx)("div",{className:_(t,"interface-pinned-items"),children:e})})};const w=E,k=window.wp.deprecated;var C=n.n(k);const A=window.wp.preferences;function I(e){return["core/edit-post","core/edit-site"].includes(e)?(C()(`${e} interface scope`,{alternative:"core interface scope",hint:"core/edit-post and core/edit-site are merging.",version:"6.6"}),"core"):e}function D(e,t){return"core"===e&&"edit-site/template"===t?(C()("edit-site/template sidebar",{alternative:"edit-post/document",version:"6.6"}),"edit-post/document"):"core"===e&&"edit-site/block-inspector"===t?(C()("edit-site/block-inspector sidebar",{alternative:"edit-post/block",version:"6.6"}),"edit-post/block"):t}const M=(e,t)=>({type:"SET_DEFAULT_COMPLEMENTARY_AREA",scope:e=I(e),area:t=D(e,t)}),R=(e,t)=>({registry:n,dispatch:s})=>{t&&(e=I(e),t=D(e,t),n.select(A.store).get(e,"isComplementaryAreaVisible")||n.dispatch(A.store).set(e,"isComplementaryAreaVisible",!0),s({type:"ENABLE_COMPLEMENTARY_AREA",scope:e,area:t}))},B=e=>({registry:t})=>{e=I(e),t.select(A.store).get(e,"isComplementaryAreaVisible")&&t.dispatch(A.store).set(e,"isComplementaryAreaVisible",!1)},P=(e,t)=>({registry:n})=>{if(!t)return;e=I(e),t=D(e,t);const s=n.select(A.store).get(e,"pinnedItems");!0!==s?.[t]&&n.dispatch(A.store).set(e,"pinnedItems",{...s,[t]:!0})},T=(e,t)=>({registry:n})=>{if(!t)return;e=I(e),t=D(e,t);const s=n.select(A.store).get(e,"pinnedItems");n.dispatch(A.store).set(e,"pinnedItems",{...s,[t]:!1})};function x(e,t){return function({registry:n}){C()("dispatch( 'core/interface' ).toggleFeature",{since:"6.0",alternative:"dispatch( 'core/preferences' ).toggle"}),n.dispatch(A.store).toggle(e,t)}}function U(e,t,n){return function({registry:s}){C()("dispatch( 'core/interface' ).setFeatureValue",{since:"6.0",alternative:"dispatch( 'core/preferences' ).set"}),s.dispatch(A.store).set(e,t,!!n)}}function N(e,t){return function({registry:n}){C()("dispatch( 'core/interface' ).setFeatureDefaults",{since:"6.0",alternative:"dispatch( 'core/preferences' ).setDefaults"}),n.dispatch(A.store).setDefaults(e,t)}}function j(e){return{type:"OPEN_MODAL",name:e}}function O(){return{type:"CLOSE_MODAL"}}const W=(0,u.createRegistrySelector)(e=>(t,n)=>{n=I(n);const s=e(A.store).get(n,"isComplementaryAreaVisible");if(void 0!==s)return!1===s?null:t?.complementaryAreas?.[n]}),H=(0,u.createRegistrySelector)(e=>(t,n)=>{n=I(n);const s=e(A.store).get(n,"isComplementaryAreaVisible"),o=t?.complementaryAreas?.[n];return s&&void 0===o}),F=(0,u.createRegistrySelector)(e=>(t,n,s)=>{var o;s=D(n=I(n),s);const r=e(A.store).get(n,"pinnedItems");return null===(o=r?.[s])||void 0===o||o}),L=(0,u.createRegistrySelector)(e=>(t,n,s)=>(C()("select( 'core/interface' ).isFeatureActive( scope, featureName )",{since:"6.0",alternative:"select( 'core/preferences' ).get( scope, featureName )"}),!!e(A.store).get(n,s)));function $(e,t){return e.activeModal===t}const V=(0,u.combineReducers)({complementaryAreas:function(e={},t){switch(t.type){case"SET_DEFAULT_COMPLEMENTARY_AREA":{const{scope:n,area:s}=t;return e[n]?e:{...e,[n]:s}}case"ENABLE_COMPLEMENTARY_AREA":{const{scope:n,area:s}=t;return{...e,[n]:s}}}return e},activeModal:function(e=null,t){switch(t.type){case"OPEN_MODAL":return t.name;case"CLOSE_MODAL":return null}return e}}),J=(0,u.createReduxStore)("core/interface",{reducer:V,actions:s,selectors:o});(0,u.register)(J);const z=({diffContext:e,onAccept:t,onReject:n})=>{const{diffs:s}=e,[o,a]=(0,r.useState)(null),[i,l]=(0,r.useState)(!1),c=(0,r.useRef)(new Set),{blocks:d,postContent:g}=(0,u.useSelect)(e=>({blocks:e("core/block-editor").getBlocks(),postContent:e("core/editor").getEditedPostAttribute("content")})),{lockPostSaving:f,unlockPostSaving:p}=(0,u.useDispatch)("core/editor"),{updateBlockAttributes:h,insertBlocks:m,replaceBlock:S,resetBlocks:y}=(0,u.useDispatch)("core/block-editor");return(0,r.useEffect)(()=>{if(s.length>0&&!i){const e=s[0],t=e.diff_id||e.tool_call_id;if(c.current.has(t))return;console.log("InlineDiffManager: Processing new diff:",e),console.log("InlineDiffManager: Diff has target_blocks:",!!e.target_blocks),e.target_blocks&&console.log("InlineDiffManager: Number of target blocks:",e.target_blocks.length);try{if(a([...d]),f("wordsurf-diff-preview"),l(!0),c.current.add(t),e.target_blocks&&e.target_blocks.length>0){if(e.target_blocks[0].is_full_replacement){console.log("InlineDiffManager: Processing full post replacement");const n=wp.blocks.parse(e.target_blocks[0].diff_block_content);return void(n.length>0?(y(n),console.log("InlineDiffManager: Successfully applied full replacement")):(l(!1),c.current.delete(t)))}console.log("InlineDiffManager: Using granular target blocks approach");const n=d.filter(e=>null!==e.name);console.log("InlineDiffManager: Frontend blocks - total:",d.length,", non-empty:",n.length),console.log("InlineDiffManager: Frontend non-empty blocks array:",n.map((e,t)=>({index:t,name:e.name,clientId:e.clientId}))),console.log("InlineDiffManager: Backend target blocks:",e.target_blocks.map(e=>({block_index:e.block_index,preview:e.block_content_preview})));try{e.target_blocks.forEach((e,t)=>{const{block_index:s,diff_wrapper_block:o}=e;console.log(`InlineDiffManager: Processing target block ${s}, total non-empty blocks: ${n.length}`);const r=wp.blocks.parse(o)[0];if(!r)return void console.error(`InlineDiffManager: Failed to parse diff wrapper block for index ${s}`);if(s>=n.length||s<0)return void console.warn(`InlineDiffManager: Skipping block index ${s} - out of bounds (total non-empty blocks: ${n.length})`);const a=n[s];a?(console.log(`InlineDiffManager: Replacing block ${s} (clientId: ${a.clientId}) with diff wrapper`),S(a.clientId,r)):console.error(`InlineDiffManager: Target block at index ${s} is undefined`)}),console.log("InlineDiffManager: Successfully processed",e.target_blocks.length,"target blocks granularly")}catch(e){console.error("InlineDiffManager: Error processing target blocks:",e),l(!1),c.current.delete(t)}}else console.error("InlineDiffManager: No target_blocks provided"),l(!1),c.current.delete(t)}catch(e){console.error("InlineDiffManager: Error processing diff:",e),l(!1),c.current.delete(t)}}},[s.length,i]),(0,r.createElement)(v.Fill,{name:"PluginHeader"},i&&(0,r.createElement)(w,null,(0,r.createElement)("div",{style:{display:"flex",gap:"8px",alignItems:"center",color:"#1e1e1e",backgroundColor:"#fff",padding:"4px 8px",borderRadius:"4px",border:"1px solid #ddd"}},(0,r.createElement)("strong",null,"Wordsurf Change Preview:"),(0,r.createElement)(v.Button,{isPrimary:!0,onClick:()=>{const e=s[0];console.log("InlineDiffManager: Header accept clicked for diff block"),p("wordsurf-diff-preview"),a(null),l(!1),c.current.delete(e.tool_call_id),t(e)}},"Accept Changes"),(0,r.createElement)(v.Button,{isSecondary:!0,onClick:()=>{const e=s[0];console.log("InlineDiffManager: Header reject clicked for diff block"),p("wordsurf-diff-preview"),a(null),l(!1),c.current.delete(e.tool_call_id),n(e)}},"Reject"))))},G=({name:e,args:t,result:n,status:s})=>{let o=t;if("string"==typeof t)try{o=JSON.parse(t)}catch(e){}return(0,r.createElement)("div",{className:"tool-call"},(0,r.createElement)("div",{className:"tool-header"},"in_progress"===s?(0,r.createElement)("div",{className:"spinner"}):!0===n?.success?(0,r.createElement)("div",{className:"icon"},"✅"):!1===n?.success?(0,r.createElement)("div",{className:"icon"},"❌"):(0,r.createElement)("div",{className:"icon"},"⚙️"),(0,r.createElement)("span",{className:"tool-name"},e)))},Y=({message:e})=>{if(e.tool_calls&&e.tool_calls.length>0)return(0,r.createElement)("div",{className:`chat-message ${e.role}`},(0,r.createElement)(G,{name:e.tool_calls[0].function.name,args:e.tool_calls[0].function.arguments,result:e.result,status:e.result?"completed":"in_progress"}));const t="user"===e.role?"user":"agent";return(0,r.createElement)("div",{className:`chat-message ${t}`},(0,r.createElement)("div",{className:"chat-bubble"},e.content,e.isStreaming&&(0,r.createElement)("span",{className:"typing-indicator"},(0,r.createElement)("span",null),(0,r.createElement)("span",null),(0,r.createElement)("span",null))))},K=({value:e,onChange:t,onSend:n,disabled:s=!1,placeholder:o="Ask me to edit, write, or brainstorm..."})=>(0,r.createElement)("div",{className:"wordsurf-input-area"},(0,r.createElement)("textarea",{value:e,onChange:t,placeholder:o,disabled:s,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),n())}}),(0,r.createElement)("button",{onClick:n,disabled:s||!e.trim()},"Send")),q=({diffs:e,onAcceptAll:t,onRejectAll:n})=>e&&0!==e.length?(console.log("PendingChanges: Rendering diff control UI for",e.length,"diffs"),(0,r.createElement)("div",{className:"wordsurf-pending-changes"},(0,r.createElement)("div",{className:"pending-changes-content"},(0,r.createElement)("div",{className:"pending-changes-label"},"Pending changes:"),(0,r.createElement)("div",{className:"pending-changes-actions"},(0,r.createElement)("button",{className:"button button-primary",onClick:t,style:{marginRight:"8px"}},"Accept All"),(0,r.createElement)("button",{className:"button button-secondary",onClick:n},"Reject All"))))):null,Q=({messages:e,isWaiting:t,inputValue:n,onInputChange:s,onSend:o,isStreaming:i,hasStreamingAssistant:l,pendingDiffs:c,onAcceptAllChanges:d,onRejectAllChanges:u})=>{const g=a().useRef(null);return a().useEffect(()=>{g.current&&(g.current.scrollTop=g.current.scrollHeight)},[e]),(0,r.createElement)("div",{className:"wordsurf-sidebar-content"},(0,r.createElement)("div",{className:"wordsurf-chat-window",ref:g},e.map((e,t)=>(0,r.createElement)(Y,{key:t,message:e})),t&&!l&&(0,r.createElement)("div",{className:"chat-message agent"},(0,r.createElement)("div",{className:"chat-bubble"},"Thinking...",(0,r.createElement)("span",{className:"typing-indicator"},(0,r.createElement)("span",null),(0,r.createElement)("span",null),(0,r.createElement)("span",null)))),(0,r.createElement)(q,{diffs:c,onAcceptAll:d,onRejectAll:u})),(0,r.createElement)(K,{value:n,onChange:s,onSend:o,disabled:i}))};class X{static removeDiffWrapper(e,t=!1){const{replaceBlocks:n}=wp.data.dispatch("core/block-editor"),{getBlocks:s}=wp.data.select("core/block-editor");if(!wp.data.select("core/block-editor").getBlock(e))throw new Error("Diff block not found");const o=s(e);if(!o||0===o.length){const{removeBlocks:t}=wp.data.dispatch("core/block-editor");return void t([e])}const r=o.map(e=>X.removeDiffTags(e,t));return n(e,r),r}static removeDiffTags(e,t){const n={...e};if(n.attributes&&n.attributes.content){let e=n.attributes.content;t?(e=e.replace(/<del[^>]*>.*?<\/del>/gi,""),e=e.replace(/<ins[^>]*>(.*?)<\/ins>/gi,"$1")):(e=e.replace(/<ins[^>]*>.*?<\/ins>/gi,""),e=e.replace(/<del[^>]*>(.*?)<\/del>/gi,"$1")),n.attributes={...n.attributes,content:e}}return n.innerBlocks&&n.innerBlocks.length>0&&(n.innerBlocks=n.innerBlocks.map(e=>X.removeDiffTags(e,t))),n}static smartTextReplace(e,t,n,s=!1){if(!e.includes("<"))return s?e.split(t).join(n):e.replace(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),n);const o=e.split(/(<[^>]+>)/);let r="";for(const e of o)e.startsWith("<")&&e.endsWith(">")?r+=e:r+=s?e.split(t).join(n):e.replace(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),n);return r}static canApplyDiff(e,t,n){const s=t||n;return e&&s&&e.includes(s)}}class Z{static findAllDiffBlocks(){const{getBlocks:e}=wp.data.select("core/block-editor");return e().filter(e=>"wordsurf/diff"===e.name)}static findDiffBlocksByDiffId(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.diffId===e)}static findDiffBlocksByToolCallId(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.toolCallId===e)}static hasDiffBlocks(){return this.findAllDiffBlocks().length>0}static getDiffBlockCount(){return this.findAllDiffBlocks().length}static findDiffBlockByClientId(e){return this.findAllDiffBlocks().find(t=>t.clientId===e)||null}static findDiffBlocksByStatus(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.status===e)}static findPendingDiffBlocks(){return this.findDiffBlocksByStatus("pending")}static getOriginalBlockContent(e){return e.attributes?.originalBlockContent||""}static getOriginalBlockType(e){return e.attributes?.originalBlockType||"core/paragraph"}static isDiffBlock(e){return"wordsurf/diff"===e?.name}}class ee{static async handleAccept(e,t,n,s=!1){const{toolCallId:o,diffId:r}=e;try{X.removeDiffWrapper(t,!0);const e=await ee.sendUserDecision("accepted",{tool_call_id:o,diff_id:r,post_id:n}),a=await e.json();if(a.continue_chat&&!s&&0===Z.findDiffBlocksByDiffId(r).filter(e=>"pending"===e.attributes?.status).length){const e=a.tool_result?.tool_call_id||o;ee.triggerChatContinuation({action:"accepted",toolCallId:e,diffId:r,postId:n})}return{success:!0}}catch(e){throw console.error("Error accepting diff:",e),e}}static async handleReject(e,t,n,s=!1){const{toolCallId:o,diffId:r}=e;try{X.removeDiffWrapper(t,!1);const e=await ee.sendUserDecision("rejected",{tool_call_id:o,diff_id:r,post_id:n}),a=await e.json();if(a.continue_chat&&!s&&0===Z.findDiffBlocksByDiffId(r).filter(e=>"pending"===e.attributes?.status).length){const e=a.tool_result?.tool_call_id||o;ee.triggerChatContinuation({action:"rejected",toolCallId:e,diffId:r,postId:n})}return{success:!0}}catch(e){throw console.error("Error rejecting diff:",e),e}}static async sendUserDecision(e,t){const n=new FormData;n.append("action","wordsurf_user_feedback"),n.append("nonce",window.wordsurfData?.nonce||""),n.append("user_action",e),n.append("tool_call_id",t.tool_call_id),n.append("diff_id",t.diff_id),n.append("post_id",t.post_id);const s=await fetch(window.wordsurfData?.ajax_url||"/wp-admin/admin-ajax.php",{method:"POST",body:n});if(!s.ok)throw new Error("Failed to send user decision");return s}static triggerChatContinuation(e){const t=new CustomEvent("wordsurf-continue-chat",{bubbles:!0,detail:{trigger:"diff_resolved",timestamp:Date.now(),toolResult:e}});document.dispatchEvent(t),console.log("DiffActions: Chat continuation event dispatched with tool result:",e)}static createActionHandlers(e,t,n,s,o){return{handleAccept:async()=>{s(!0);try{o({status:"accepted"}),await ee.handleAccept(e,t,n)}catch(e){throw o({status:"pending"}),e}finally{s(!1)}},handleReject:async()=>{s(!0);try{o({status:"rejected"}),await ee.handleReject(e,t,n)}catch(e){throw o({status:"pending"}),e}finally{s(!1)}}}}}class te{static async acceptAll(){const{getCurrentPostId:e}=wp.data.select("core/editor"),t=Z.findAllDiffBlocks(),n=e();console.log("HandleAcceptAll: Processing",t.length,"diff blocks");let s=null,o=null;for(let e=0;e<t.length;e++){const r=t[e],a=e===t.length-1;try{s=r.attributes.toolCallId,o=r.attributes.diffId,await ee.handleAccept(r.attributes,r.clientId,n,!a),console.log("HandleAcceptAll: Accepted diff block",r.attributes.diffId)}catch(e){console.error("HandleAcceptAll: Error accepting diff block",r.attributes.diffId,e)}}return t.length>1&&s&&ee.triggerChatContinuation({action:"accepted",toolCallId:s,diffId:o,postId:n,isAcceptAll:!0}),t.length}static async rejectAll(){const{getCurrentPostId:e}=wp.data.select("core/editor"),t=Z.findAllDiffBlocks(),n=e();console.log("HandleAcceptAll: Rejecting",t.length,"diff blocks");let s=null,o=null;for(let e=0;e<t.length;e++){const r=t[e],a=e===t.length-1;try{s=r.attributes.toolCallId,o=r.attributes.diffId,await ee.handleReject(r.attributes,r.clientId,n,!a),console.log("HandleAcceptAll: Rejected diff block",r.attributes.diffId)}catch(e){console.error("HandleAcceptAll: Error rejecting diff block",r.attributes.diffId,e)}}return t.length>1&&s&&ee.triggerChatContinuation({action:"rejected",toolCallId:s,diffId:o,postId:n,isAcceptAll:!0}),t.length}}const ne="wordsurf",se=(0,c.__)("Wordsurf","wordsurf"),oe=()=>(0,r.createElement)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},(0,r.createElement)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8 8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z",fill:"currentColor"}),(0,r.createElement)("path",{d:"M12 12m-6 0a6 6 0 1 0 12 0a6 6 0 1 0 -12 0",fill:"currentColor",fillOpacity:"0.3"}));wp.plugins.getPlugin(ne)||(0,i.registerPlugin)(ne,{render:()=>{const[e,t]=(0,d.useState)({originalContent:"",diffs:[]});(0,d.useEffect)(()=>{e.diffs.length>0&&console.log("WordsurfPlugin: diffContext has diffs:",e)},[e.diffs.length]);const n=(0,d.useRef)(new S([])),s=(0,u.useSelect)(e=>{const{getCurrentPostId:t,getEditedPostAttribute:n}=e("core/editor"),{getBlocks:s}=e("core/block-editor");return{postId:t(),title:n("title"),content:n("content"),status:n("status"),type:n("type"),blocks:s()}});(0,d.useEffect)(()=>{e.diffs.length>0&&s.blocks&&(Z.hasDiffBlocks()||(console.log("WordsurfPlugin: No diff blocks remaining in editor - resetting chat state"),t(e=>({...e,diffs:[]}))))},[s.blocks,e.diffs.length]);const o=(0,d.useCallback)(e=>{console.log("WordsurfPlugin: Received diff data:",e),console.log("WordsurfPlugin: Has diff_block_content:",!!e.diff_block_content),t(t=>({...t,diffs:[...t.diffs,e]}))},[]),a=(({postId:e,onDiffReceived:t,onUserDecision:n,chatHistory:s})=>{const o=(0,r.useRef)(null);o.current||(o.current=new p(s.current,t));const a=o.current,[i,l]=(0,r.useState)(a.getState()),[c,d]=(0,r.useState)(""),u=(0,r.useCallback)(()=>{l(a.getState())},[a]);(0,r.useEffect)(()=>()=>{a.cleanup()},[a]),(0,r.useEffect)(()=>{a.setInputValue(c)},[c,a]);const f=(0,r.useCallback)(()=>{const t=c.trim();!t||a.isStreaming||a.hasSentMessage||a.currentEventSource||(s.current.addUserMessage(t),u(),d(""),a.startStream(s.current.getOpenAIMessages(),e,g,u,u,u))},[c,a,s,e,u]),m=(0,r.useCallback)((e,t)=>{s.current.addUserDecision(e,t),u();const n=new FormData;n.append("action","wordsurf_tool_action"),n.append("action_type",e),n.append("tool_call_id",t.tool_call_id),n.append("tool_data",JSON.stringify(t)),n.append("nonce",window.wordsurfData?.nonce||""),fetch(window.wordsurfData.ajax_url,{method:"POST",body:n}).then(e=>e.json()).then(e=>{e.success?console.log("Tool action processed successfully:",e):console.error("Tool action failed:",e)}).catch(e=>{console.error("Error processing tool action:",e)})},[s,u]),S=(0,r.useCallback)(()=>{console.log("ChatHandler: Resetting for continuation"),a.hasSentMessage=!1,a.isStreaming=!1,a.isWaiting=!1,u()},[a,u]),y=(0,r.useCallback)(e=>{if(console.log("ChatHandler: Continuing with tool result:",e),a.isStreaming||a.hasSentMessage||a.currentEventSource||h)return void console.log("ChatHandler: Cannot continue - already streaming or has sent message",{isStreaming:a.isStreaming,hasSentMessage:a.hasSentMessage,hasEventSource:!!a.currentEventSource,globalActive:h});console.log("ChatHandler: Starting continuation via AI HTTP Client library"),a.currentEventSource&&(console.log("ChatHandler: Closing existing EventSource before creating new one"),a.currentEventSource.close(),a.currentEventSource=null);const t=new FormData;t.append("action","wordsurf_continue_with_tool_result"),t.append("nonce",window.wordsurfData?.nonce||""),t.append("tool_call_id",e.toolCallId),t.append("user_action",e.action),t.append("post_id",e.postId);const n=new URLSearchParams;for(const[e,s]of t.entries())n.append(e,s);h=!0,console.log("ChatHandler: Creating new EventSource for tool result continuation");const s=new EventSource(`${window.wordsurfData?.ajax_url}?${n.toString()}`);a.isStreaming=!0,a.hasSentMessage=!0,a.isWaiting=!0,a.currentEventSource=s,u(),s.onmessage=e=>{try{const t=JSON.parse(e.data);a.handleEvent(t),"stream_end"===t.type&&(h=!1)}catch(e){console.error("Error parsing SSE data:",e)}},s.onerror=e=>{console.error("EventSource error:",e),s.close(),a.isStreaming=!1,a.isWaiting=!1,a.hasSentMessage=!1,a.currentEventSource=null,h=!1,u()},s.onopen=()=>{console.log("Tool result continuation stream opened")}},[a,s,u]);return{isStreaming:i.isStreaming,isWaiting:i.isWaiting,inputValue:c,setInputValue:d,uiMessages:i.uiMessages,handleSend:f,updateUIMessages:u,recordUserDecision:m,resetForContinuation:S,continueWithToolResult:y,hasStreamingAssistant:i.hasStreamingAssistant,currentEventSource:a.currentEventSource,session:a}})({postId:s.postId,onDiffReceived:o,chatHistory:n});(0,d.useEffect)(()=>{const e=e=>{console.log("WordsurfPlugin: Chat continuation event received:",e.detail);const{toolResult:n}=e.detail;if(n&&n.isAcceptAll&&(console.log("WordsurfPlugin: Clearing pending diffs for accept all operation"),t(e=>({...e,diffs:[]}))),!a||a.isStreaming||a.isWaiting||a.currentEventSource)console.log("WordsurfPlugin: Skipping chat continuation - already streaming or waiting",{isStreaming:a?.isStreaming,isWaiting:a?.isWaiting,hasEventSource:!!a?.currentEventSource});else{console.log("WordsurfPlugin: Triggering model-driven continuation with tool result");const{toolResult:t}=e.detail;t&&t.toolCallId?a.continueWithToolResult(t):a.resetForContinuation()}};document.addEventListener("wordsurf-continue-chat",e);const n=e=>{if(console.log("WordsurfPlugin: EventSource error event received:",e),a&&a.currentEventSource){console.log("WordsurfPlugin: Attempting to recover from EventSource error");const e=a.session;e&&e.forceCleanupConnection()}};return window.addEventListener("error",n),()=>{document.removeEventListener("wordsurf-continue-chat",e),window.removeEventListener("error",n)}},[a]);const i=(0,d.useCallback)(e=>{n.current.addUserDecision("accepted",e),t(t=>({...t,diffs:t.diffs.filter(t=>t.tool_call_id!==e.tool_call_id)}))},[n]),c=(0,d.useCallback)(e=>{n.current.addUserDecision("rejected",e),t(t=>({...t,diffs:t.diffs.filter(t=>t.tool_call_id!==e.tool_call_id)}))},[n]),f=(0,d.useCallback)(async()=>{console.log("WordsurfPlugin: Accept all clicked");try{const s=await te.acceptAll();console.log("WordsurfPlugin: Accepted",s,"diff blocks"),e.diffs.forEach(e=>{n.current.addUserDecision("accepted",e)}),t(e=>({...e,diffs:[]}))}catch(e){console.error("WordsurfPlugin: Error accepting all changes:",e)}},[e.diffs,a]),m=(0,d.useCallback)(async()=>{console.log("WordsurfPlugin: Reject all clicked");try{const s=await te.rejectAll();console.log("WordsurfPlugin: Rejected",s,"diff blocks"),e.diffs.forEach(e=>{n.current.addUserDecision("rejected",e)}),t(e=>({...e,diffs:[]}))}catch(e){console.error("WordsurfPlugin: Error rejecting all changes:",e)}},[e.diffs,a]),y=(0,d.useCallback)(()=>{t(e=>({...e,originalContent:s.content,diffs:[]})),a.handleSend()},[s.content,a,t]);return(0,r.createElement)(r.Fragment,null,(0,r.createElement)(l.PluginSidebarMoreMenuItem,{target:ne},se),(0,r.createElement)(l.PluginSidebar,{name:ne,title:se,icon:(0,r.createElement)(oe,null)},(0,r.createElement)(Q,{messages:a.uiMessages,isWaiting:a.isWaiting,inputValue:a.inputValue,onInputChange:e=>a.setInputValue(e.target.value),onSend:y,isStreaming:a.isStreaming,hasStreamingAssistant:a.hasStreamingAssistant,pendingDiffs:e.diffs,onAcceptAllChanges:f,onRejectAllChanges:m})),(0,r.createElement)(z,{diffContext:e,onAccept:i,onReject:c,key:`diff-manager-${e.diffs.length}`}))}})})();