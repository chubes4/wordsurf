(()=>{"use strict";const e=window.React,t=window.wp.plugins,a=window.wp.editPost,n=(window.wp.components,window.wp.i18n),r=(window.wp.element,window.wp.data),s=({name:t,status:a})=>(0,e.createElement)("div",{className:"tool-call"},"in_progress"===a?(0,e.createElement)("div",{className:"spinner"}):"success"===a?(0,e.createElement)("div",{className:"icon"},"✅"):"error"===a?(0,e.createElement)("div",{className:"icon"},"❌"):null,(0,e.createElement)("span",{className:"tool-call-name"},t),"in_progress"!==a&&(0,e.createElement)("span",{className:"tool-call-status"},a)),o=({initialMessages:t=[],postId:a,onSend:n})=>{const[r,o]=(0,e.useState)(t),[c,l]=(0,e.useState)(""),[i,d]=(0,e.useState)(!1),[m,u]=(0,e.useState)(""),[p,w]=(0,e.useState)([]),[g,E]=(0,e.useState)(!1),f=(0,e.useRef)(""),h=(0,e.useRef)(null);(0,e.useEffect)(()=>{h.current&&(h.current.scrollTop=h.current.scrollHeight)},[r,m,p]);const y=async()=>{if(!c.trim()||i)return;const e=c.trim(),t=[...r.map(e=>"user"===e.author?{role:"user",content:e.content}:{role:"assistant",content:e.content}),{role:"user",content:e}];o(t=>[...t,{author:"user",content:e}]),l(""),d(!0),u(""),w([]),f.current="",E(!0),n&&n(e),await async function(e,t,a,n,r){console.log("Wordsurf DEBUG: streamChatMessage called with messages:",e),console.log("Wordsurf DEBUG: postId:",t);try{const r=new FormData;r.append("action","wordsurf_stream_chat"),r.append("messages",JSON.stringify(e)),r.append("post_id",t),r.append("nonce",window.wordsurfData?.nonce||"");const s=await fetch("/wp-admin/admin-ajax.php",{method:"POST",body:r});if(!s.body)throw new Error("No response body");const o=s.body.getReader(),c=new TextDecoder;let l="";for(;;){const{value:e,done:t}=await o.read();if(t)break;l+=c.decode(e,{stream:!0});let n=l.split("\n\n");l=n.pop();for(const e of n)if(e.startsWith("data: ")){const t=e.replace("data: ","");try{a(JSON.parse(t))}catch(e){console.error("Wordsurf DEBUG: JSON parse error:",e.message,"for event:",t)}}}n&&n()}catch(e){console.error("Wordsurf DEBUG: Stream error:",e),r&&r()}}(t,a,e=>{E(!1),e.type&&e.data&&("tool_start"===e.type?w(t=>[...t,{name:e.data.name,status:"in_progress"}]):"tool_end"===e.type?w(t=>t.map(t=>t.name===e.data.name?{...t,status:e.data.status}:t)):"system"===e.type?w(t=>[...t,{name:e.data.content,status:"system"}]):"text"===e.type&&(p.length>0&&w([]),e.data.content&&(f.current+=e.data.content,u(f.current))))},()=>{f.current&&o(e=>[...e,{author:"agent",content:f.current}]),u(""),w([]),d(!1),E(!1)},e=>{d(!1),w([]),u(""),E(!1),o(e=>[...e,{author:"agent",content:"Sorry, there was an error."}])})};return(0,e.createElement)("div",{className:"wordsurf-sidebar-content"},(0,e.createElement)("div",{className:"wordsurf-chat-window",ref:h},r.map((t,a)=>(0,e.createElement)("div",{key:a,className:`chat-message ${t.author}`},(0,e.createElement)("div",{className:"chat-bubble"},t.content))),g&&(0,e.createElement)(s,{name:"Thinking...",status:"system"}),p.map((t,a)=>(0,e.createElement)(s,{key:a,name:t.name,status:t.status})),i&&m&&(0,e.createElement)("div",{className:"chat-message agent"},(0,e.createElement)("div",{className:"chat-bubble"},m,(0,e.createElement)("span",{className:"typing-indicator"},(0,e.createElement)("span",null),(0,e.createElement)("span",null),(0,e.createElement)("span",null))))),(0,e.createElement)("div",{className:"wordsurf-input-area"},(0,e.createElement)("textarea",{value:c,onChange:e=>l(e.target.value),placeholder:"Ask me to edit, write, or brainstorm...",disabled:i,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),y())}}),(0,e.createElement)("button",{onClick:y,disabled:i||!c.trim()},"Send")))},c="wordsurf",l=(0,n.__)("Wordsurf","wordsurf"),i=()=>(0,e.createElement)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},(0,e.createElement)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z",fill:"currentColor"}),(0,e.createElement)("path",{d:"M12 12m-6 0a6 6 0 1 0 12 0a6 6 0 1 0 -12 0",fill:"currentColor","fill-opacity":"0.3"}));(0,t.registerPlugin)(c,{render:()=>{const t=(0,r.useSelect)(e=>{const{getCurrentPostId:t,getEditedPostAttribute:a}=e("core/editor");return{postId:t(),title:a("title"),content:a("content"),status:a("status"),type:a("type")}});return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(a.PluginSidebarMoreMenuItem,{target:c},l),(0,e.createElement)(a.PluginSidebar,{name:c,title:l,icon:(0,e.createElement)(i,null)},(0,e.createElement)(o,{postId:t.postId,onSend:e=>{console.log("Message sent:",e)}})))}})})();