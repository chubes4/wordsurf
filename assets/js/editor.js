(()=>{"use strict";var e={20:(e,t,s)=>{var n=s(609),o=Symbol.for("react.element"),r=(Symbol.for("react.fragment"),Object.prototype.hasOwnProperty),a=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};t.jsx=function(e,t,s){var n,l={},c=null,d=null;for(n in void 0!==s&&(c=""+s),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(d=t.ref),t)r.call(t,n)&&!i.hasOwnProperty(n)&&(l[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===l[n]&&(l[n]=t[n]);return{$$typeof:o,type:e,key:c,ref:d,props:l,_owner:a.current}}},609:e=>{e.exports=window.React},848:(e,t,s)=>{e.exports=s(20)}},t={};function s(n){var o=t[n];if(void 0!==o)return o.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,s),r.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};s.r(n),s.d(n,{closeModal:()=>W,disableComplementaryArea:()=>B,enableComplementaryArea:()=>P,openModal:()=>O,pinItem:()=>T,setDefaultComplementaryArea:()=>R,setFeatureDefaults:()=>j,setFeatureValue:()=>U,toggleFeature:()=>N,unpinItem:()=>x});var o={};s.r(o),s.d(o,{getActiveComplementaryArea:()=>H,isComplementaryAreaLoading:()=>F,isFeatureActive:()=>$,isItemPinned:()=>L,isModalActive:()=>V});var r=s(609),a=s.n(r);const i=window.wp.plugins,l=window.wp.editor,c=window.wp.i18n,d=window.wp.element,u=window.wp.data;function g(e,t,s,n,o){const r=new URLSearchParams({action:"wordsurf_stream_chat",messages:JSON.stringify(e),post_id:t,context_window:JSON.stringify({}),nonce:window.wordsurfData?.nonce||""}),a=new EventSource(`${window.wordsurfData.ajax_url}?${r.toString()}`);let i=!1,l=!1,c=!1;return a.onmessage=function(e){console.log("ðŸš€ DEFAULT MESSAGE EVENT:",e.type,e.data)},a.onopen=function(e){console.log("ðŸŸ¢ EventSource connection opened")},a.onerror=function(e){console.log("ðŸ”´ EventSource error event:",e,"readyState:",a.readyState)},a.addEventListener("response.output_text.delta",e=>{try{const t=JSON.parse(e.data);t.delta&&s({type:"text",data:{content:t.delta}})}catch(t){console.error("Failed to parse text delta:",e.data,t)}}),a.addEventListener("response.output_item.added",e=>{try{const t=JSON.parse(e.data);t.item&&"function_call"===t.item.type&&(c=!0,s({type:"tool_start",data:t.item}))}catch(t){console.error("Failed to parse tool start:",e.data,t)}}),a.addEventListener("tool_result",e=>{console.log("ðŸ”§ TOOL_RESULT EVENT RECEIVED:",e.data),console.log("ðŸ”§ Event object:",e),console.log("ðŸ”§ EventSource readyState:",a.readyState);try{const t=JSON.parse(e.data);console.log("ðŸ”§ Parsed tool result:",t),console.log("ðŸ”§ About to call onEvent with:",{type:"tool_result",data:t}),s({type:"tool_result",data:t}),l=!0,a.close(),n&&n()}catch(t){console.error("Failed to parse tool result:",e.data,t)}}),a.addEventListener("response.completed",e=>{i=!0;try{const t=JSON.parse(e.data);console.log("StreamApi: Stream completed by API.",t),s({type:"stream_end",data:t.response}),c?console.log("StreamApi: Stream completed, keeping connection open for tool results"):(console.log("StreamApi: Stream completed, no tools detected, closing immediately"),l=!0,a.close(),n&&n())}catch(t){console.error("Failed to parse response.completed event:",e.data,t),s({type:"stream_end",data:{status:"completed"}}),l||(console.log("StreamApi: Parse error recovery - closing connection immediately"),l=!0,a.close(),n&&n())}}),a.addEventListener("message",e=>{e.type.startsWith("response.")||console.log("StreamApi: Received unexpected message event:",e)}),a.addEventListener("error",e=>{l||(l=!0,a.close()),i||a.readyState===EventSource.CLOSED||(console.error("StreamApi: EventSource error:",e),o&&o(e))}),a}class f{constructor(e,t){this.chatHistory=e,this.onDiffReceived=t,this.isStreaming=!1,this.isWaiting=!1,this.streamingBuffer="",this.accumulatedContent="",this.hasSentMessage=!1,this.currentEventSource=null,this.animationFrameId=null,this.onUIUpdate=null,this.streamingMessageIndex=-1}startStream(e,t,s,n,o,r){this.isStreaming||this.hasSentMessage||this.currentEventSource||(this.isStreaming=!0,this.isWaiting=!0,this.hasSentMessage=!0,this.streamingBuffer="",this.accumulatedContent="",this.onUIUpdate=r,this.streamingMessageIndex=-1,this.currentEventSource=s(e,t,e=>this.handleEvent(e),()=>this.handleComplete(n),e=>this.handleError(o,e)),this.onUIUpdate&&this.onUIUpdate())}handleEvent(e){if(e.type&&e.data){switch(e.type){case"tool_start":this.isWaiting=!1,this.flushStreamingBuffer(),this.chatHistory.addToolCall(e.data.call_id,e.data.name,e.data.arguments),this.finalizeStreamingMessage();break;case"text":this.isWaiting=!1,null!=e.data.content&&(this.streamingBuffer+=e.data.content,this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>{this.flushStreamingBuffer(),this.onUIUpdate&&this.onUIUpdate()})));break;case"stream_end":this.finalizeStreamingMessage();break;case"tool_result":this.isWaiting=!1;const{tool_call_id:t,tool_name:s,result:n}=e.data;console.log("ChatStreamSession: Received tool_result:",{tool_call_id:t,tool_name:s,result:n,preview:n.preview,hasCallback:!!this.onDiffReceived}),this.chatHistory.updateToolCall(t,{success:n.success,completed:!0,...n}),!0===n.preview&&this.onDiffReceived?(console.log("ChatStreamSession: CALLING onDiffReceived with diff data"),console.log("ChatStreamSession: Full result data:",n),this.onDiffReceived({tool_call_id:t,original_content:n.original_content,new_content:n.new_content,search_pattern:n.search_pattern,replacement_text:n.replacement_text,diff_block_content:n.diff_block_content,target_blocks:n.target_blocks,diff_id:n.diff_id,tool_name:s,message:n.message})):console.log("ChatStreamSession: NOT calling onDiffReceived because:",{hasPreview:!0===n.preview,hasCallback:!!this.onDiffReceived,preview:n.preview})}this.onUIUpdate&&this.onUIUpdate()}}flushStreamingBuffer(){this.streamingBuffer.length>0&&(this.accumulatedContent+=this.streamingBuffer,-1===this.streamingMessageIndex?(this.chatHistory.addAssistantMessage(this.accumulatedContent,!0),this.streamingMessageIndex=this.chatHistory.getMessageCount()-1):this.chatHistory.updateMessageContent(this.streamingMessageIndex,this.accumulatedContent),this.streamingBuffer=""),this.animationFrameId=null}finalizeStreamingMessage(){-1!==this.streamingMessageIndex&&this.chatHistory.updateMessageStreamingStatus(this.streamingMessageIndex,!1)}handleComplete(e){this.streamingBuffer.length>0&&this.flushStreamingBuffer(),this.finalizeStreamingMessage(),this.isStreaming=!1,this.isWaiting=!1,this.hasSentMessage=!1,this.currentEventSource=null,this.streamingMessageIndex=-1,this.accumulatedContent="",e&&e(),this.onUIUpdate&&this.onUIUpdate()}handleError(e,t){this.streamingBuffer.length>0?this.flushStreamingBuffer():0===this.accumulatedContent.length&&this.chatHistory.addAssistantMessage("Sorry, there was an error.",!1),this.finalizeStreamingMessage(),this.isStreaming=!1,this.isWaiting=!1,this.hasSentMessage=!1,this.currentEventSource=null,this.streamingMessageIndex=-1,this.accumulatedContent="",e&&e(t),this.onUIUpdate&&this.onUIUpdate()}getState(){return{isStreaming:this.isStreaming,isWaiting:this.isWaiting,uiMessages:this.chatHistory.getUIMessages(),hasStreamingAssistant:this.hasStreamingAssistantMessage()}}hasStreamingAssistantMessage(){return this.chatHistory.getUIMessages().some(e=>"assistant"===e.role&&e.isStreaming)}setInputValue(e){this.inputValue=e}getInputValue(){return this.inputValue||""}cleanup(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.currentEventSource&&this.currentEventSource.close()}}function p(e){if(!e.role)throw new Error("Message must have a role property");if(!["user","assistant","tool","system"].includes(e.role))throw new Error(`Invalid role: ${e.role}`);return e}function h(e){return e.map(p)}function m(e){return{role:"user",content:e,type:"text",author:"user"}}class _{constructor(){this.pendingToolResults=new Map}createToolCall(e,t,s){return function(e,t,s){return{role:"assistant",id:e,author:"agent",type:"tool",tool_name:t,tool_args:s,result:null,isStreaming:!0}}(e,t,s)}createToolResult(e,t){return function(e,t){return{role:"tool",tool_call_id:e,content:JSON.stringify(t),author:"agent",type:"tool",tool_name:t.tool_name||"",tool_args:t.tool_args||{},result:t,isStreaming:!1}}(e,t)}createToolCallAndResult(e,t,s,n){return[this.createToolCall(e,t,s),this.createToolResult(e,n)]}trackPendingResult(e,t,s,n){return this.pendingToolResults.set(e,{name:t,arguments:s,result:n}),this}getPendingResultMessages(){const e=[];return this.pendingToolResults.forEach((t,s)=>{const[n,o]=this.createToolCallAndResult(s,t.name,t.arguments,t.result);e.push(n,o)}),e}clearPendingResults(){return this.pendingToolResults.clear(),this}hasPendingResults(){return this.pendingToolResults.size>0}getPendingResultCount(){return this.pendingToolResults.size}createUserDecisionMessage(e,t){return m(("accepted"===e?"accepted":"rejected")+" change")}getAcceptanceDetails(e,t){switch(e){case"edit_post":return` The text "${t.search_pattern}" was changed to "${t.replacement_text}" in the post.`;case"insert_content":return" New content was added to the post.";case"write_to_post":return" The post content was completely replaced.";default:return""}}debug(){console.log("ToolHistory Debug:",{pendingToolResults:this.pendingToolResults.size,pendingTools:Array.from(this.pendingToolResults.keys())})}}class y{constructor(e=[]){this.messages=this.validateInitialMessages(e),this.toolHistory=new _}validateInitialMessages(e){return h(e)}getMessages(){return[...this.messages]}getOpenAIMessages(){return h(this.messages.filter(e=>"user"!==e.role||!e.content||!e.content.startsWith("User accepted the")&&!e.content.startsWith("User rejected the")).map(e=>{const{isStreaming:t,...s}=e;return"tool"===s.type&&"assistant"===s.role?{role:"assistant",tool_calls:[{id:s.id,type:"function",function:{name:s.tool_name,arguments:"string"==typeof s.tool_args?s.tool_args:JSON.stringify(s.tool_args||{})}}]}:s}))}getUIMessages(){return this.messages.filter(e=>"text"===e.type||"tool"===e.type)}addUserMessage(e){return this.messages.push(m(e)),this}addAssistantMessage(e,t=!1){return this.messages.push(function(e,t=!1){return{role:"assistant",content:e,type:"text",author:"agent",isStreaming:t}}(e,t)),this}updateMessageContent(e,t){return this.messages[e]&&(this.messages[e].content=t),this}updateMessageStreamingStatus(e,t){return this.messages[e]&&(this.messages[e].isStreaming=t),this}addToolCall(e,t,s){return this.messages.some(t=>"tool"===t.type&&t.id===e)||this.messages.push({role:"assistant",id:e,author:"agent",type:"tool",tool_name:t,tool_args:s,result:null,isStreaming:!0}),this}updateToolCall(e,t){const s=this.messages.find(t=>"tool"===t.type&&t.id===e);return s&&(s.result=t,s.isStreaming=!1),this}addToolResult(e,t){const s=this.toolHistory.createToolResult(e,t);return this.messages.push(s),this}addToolCallAndResult(e,t,s,n){const[o,r]=this.toolHistory.createToolCallAndResult(e,t,s,n);return this.messages.push(o,r),this}trackPendingToolResult(e,t,s,n){return this.toolHistory.trackPendingResult(e,t,s,n),this}flushPendingToolResults(){const e=this.toolHistory.getPendingResultMessages();return this.messages.push(...e),this.toolHistory.clearPendingResults(),this}addUserDecision(e,t){const s=this.toolHistory.createUserDecisionMessage(e,t);return this.messages.push(s),this}clear(){return this.messages=[],this.toolHistory.clearPendingResults(),this}getLastMessage(){return this.messages[this.messages.length-1]||null}getMessageCount(){return this.messages.length}setMessages(e){return this.messages=h(e),this}debug(){console.log("ChatHistory Debug:",{messageCount:this.messages.length,messages:this.messages}),this.toolHistory.debug()}}function S(e){var t,s,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e)if(Array.isArray(e)){var o=e.length;for(t=0;t<o;t++)e[t]&&(s=S(e[t]))&&(n&&(n+=" "),n+=s)}else for(s in e)e[s]&&(n&&(n+=" "),n+=s);return n}const b=function(){for(var e,t,s=0,n="",o=arguments.length;s<o;s++)(e=arguments[s])&&(t=S(e))&&(n&&(n+=" "),n+=t);return n},w=window.wp.components;var E=s(848);function v({scope:e,...t}){return(0,E.jsx)(w.Fill,{name:`PinnedItems/${e}`,...t})}v.Slot=function({scope:e,className:t,...s}){return(0,E.jsx)(w.Slot,{name:`PinnedItems/${e}`,...s,children:e=>e?.length>0&&(0,E.jsx)("div",{className:b(t,"interface-pinned-items"),children:e})})};const k=v,A=window.wp.deprecated;var C=s.n(A);const I=window.wp.preferences;function D(e){return["core/edit-post","core/edit-site"].includes(e)?(C()(`${e} interface scope`,{alternative:"core interface scope",hint:"core/edit-post and core/edit-site are merging.",version:"6.6"}),"core"):e}function M(e,t){return"core"===e&&"edit-site/template"===t?(C()("edit-site/template sidebar",{alternative:"edit-post/document",version:"6.6"}),"edit-post/document"):"core"===e&&"edit-site/block-inspector"===t?(C()("edit-site/block-inspector sidebar",{alternative:"edit-post/block",version:"6.6"}),"edit-post/block"):t}const R=(e,t)=>({type:"SET_DEFAULT_COMPLEMENTARY_AREA",scope:e=D(e),area:t=M(e,t)}),P=(e,t)=>({registry:s,dispatch:n})=>{t&&(e=D(e),t=M(e,t),s.select(I.store).get(e,"isComplementaryAreaVisible")||s.dispatch(I.store).set(e,"isComplementaryAreaVisible",!0),n({type:"ENABLE_COMPLEMENTARY_AREA",scope:e,area:t}))},B=e=>({registry:t})=>{e=D(e),t.select(I.store).get(e,"isComplementaryAreaVisible")&&t.dispatch(I.store).set(e,"isComplementaryAreaVisible",!1)},T=(e,t)=>({registry:s})=>{if(!t)return;e=D(e),t=M(e,t);const n=s.select(I.store).get(e,"pinnedItems");!0!==n?.[t]&&s.dispatch(I.store).set(e,"pinnedItems",{...n,[t]:!0})},x=(e,t)=>({registry:s})=>{if(!t)return;e=D(e),t=M(e,t);const n=s.select(I.store).get(e,"pinnedItems");s.dispatch(I.store).set(e,"pinnedItems",{...n,[t]:!1})};function N(e,t){return function({registry:s}){C()("dispatch( 'core/interface' ).toggleFeature",{since:"6.0",alternative:"dispatch( 'core/preferences' ).toggle"}),s.dispatch(I.store).toggle(e,t)}}function U(e,t,s){return function({registry:n}){C()("dispatch( 'core/interface' ).setFeatureValue",{since:"6.0",alternative:"dispatch( 'core/preferences' ).set"}),n.dispatch(I.store).set(e,t,!!s)}}function j(e,t){return function({registry:s}){C()("dispatch( 'core/interface' ).setFeatureDefaults",{since:"6.0",alternative:"dispatch( 'core/preferences' ).setDefaults"}),s.dispatch(I.store).setDefaults(e,t)}}function O(e){return{type:"OPEN_MODAL",name:e}}function W(){return{type:"CLOSE_MODAL"}}const H=(0,u.createRegistrySelector)(e=>(t,s)=>{s=D(s);const n=e(I.store).get(s,"isComplementaryAreaVisible");if(void 0!==n)return!1===n?null:t?.complementaryAreas?.[s]}),F=(0,u.createRegistrySelector)(e=>(t,s)=>{s=D(s);const n=e(I.store).get(s,"isComplementaryAreaVisible"),o=t?.complementaryAreas?.[s];return n&&void 0===o}),L=(0,u.createRegistrySelector)(e=>(t,s,n)=>{var o;n=M(s=D(s),n);const r=e(I.store).get(s,"pinnedItems");return null===(o=r?.[n])||void 0===o||o}),$=(0,u.createRegistrySelector)(e=>(t,s,n)=>(C()("select( 'core/interface' ).isFeatureActive( scope, featureName )",{since:"6.0",alternative:"select( 'core/preferences' ).get( scope, featureName )"}),!!e(I.store).get(s,n)));function V(e,t){return e.activeModal===t}const J=(0,u.combineReducers)({complementaryAreas:function(e={},t){switch(t.type){case"SET_DEFAULT_COMPLEMENTARY_AREA":{const{scope:s,area:n}=t;return e[s]?e:{...e,[s]:n}}case"ENABLE_COMPLEMENTARY_AREA":{const{scope:s,area:n}=t;return{...e,[s]:n}}}return e},activeModal:function(e=null,t){switch(t.type){case"OPEN_MODAL":return t.name;case"CLOSE_MODAL":return null}return e}}),z=(0,u.createReduxStore)("core/interface",{reducer:J,actions:n,selectors:o});(0,u.register)(z);const Y=({diffContext:e,onAccept:t,onReject:s})=>{const{diffs:n}=e,[o,a]=(0,r.useState)(null),[i,l]=(0,r.useState)(!1),c=(0,r.useRef)(new Set),{blocks:d,postContent:g}=(0,u.useSelect)(e=>({blocks:e("core/block-editor").getBlocks(),postContent:e("core/editor").getEditedPostAttribute("content")})),{lockPostSaving:f,unlockPostSaving:p}=(0,u.useDispatch)("core/editor"),{updateBlockAttributes:h,insertBlocks:m,replaceBlock:_,resetBlocks:y}=(0,u.useDispatch)("core/block-editor");return(0,r.useEffect)(()=>{if(n.length>0&&!i){const e=n[0],t=e.diff_id||e.tool_call_id;if(c.current.has(t))return;console.log("InlineDiffManager: Processing new diff:",e),console.log("InlineDiffManager: Diff has target_blocks:",!!e.target_blocks),e.target_blocks&&console.log("InlineDiffManager: Number of target blocks:",e.target_blocks.length);try{if(a([...d]),f("wordsurf-diff-preview"),l(!0),c.current.add(t),e.target_blocks&&e.target_blocks.length>0){if(e.target_blocks[0].is_full_replacement){console.log("InlineDiffManager: Processing full post replacement");const s=wp.blocks.parse(e.target_blocks[0].diff_block_content);return void(s.length>0?(y(s),console.log("InlineDiffManager: Successfully applied full replacement")):(l(!1),c.current.delete(t)))}console.log("InlineDiffManager: Using granular target blocks approach");const s=d.filter(e=>null!==e.name);console.log("InlineDiffManager: Frontend blocks - total:",d.length,", non-empty:",s.length),console.log("InlineDiffManager: Frontend non-empty blocks array:",s.map((e,t)=>({index:t,name:e.name,clientId:e.clientId}))),console.log("InlineDiffManager: Backend target blocks:",e.target_blocks.map(e=>({block_index:e.block_index,preview:e.block_content_preview})));try{e.target_blocks.forEach((e,t)=>{const{block_index:n,diff_wrapper_block:o}=e;console.log(`InlineDiffManager: Processing target block ${n}, total non-empty blocks: ${s.length}`);const r=wp.blocks.parse(o)[0];if(!r)return void console.error(`InlineDiffManager: Failed to parse diff wrapper block for index ${n}`);if(n>=s.length||n<0)return void console.warn(`InlineDiffManager: Skipping block index ${n} - out of bounds (total non-empty blocks: ${s.length})`);const a=s[n];a?(console.log(`InlineDiffManager: Replacing block ${n} (clientId: ${a.clientId}) with diff wrapper`),_(a.clientId,r)):console.error(`InlineDiffManager: Target block at index ${n} is undefined`)}),console.log("InlineDiffManager: Successfully processed",e.target_blocks.length,"target blocks granularly")}catch(e){console.error("InlineDiffManager: Error processing target blocks:",e),l(!1),c.current.delete(t)}}else console.error("InlineDiffManager: No target_blocks provided"),l(!1),c.current.delete(t)}catch(e){console.error("InlineDiffManager: Error processing diff:",e),l(!1),c.current.delete(t)}}},[n.length,i]),(0,r.createElement)(w.Fill,{name:"PluginHeader"},i&&(0,r.createElement)(k,null,(0,r.createElement)("div",{style:{display:"flex",gap:"8px",alignItems:"center",color:"#1e1e1e",backgroundColor:"#fff",padding:"4px 8px",borderRadius:"4px",border:"1px solid #ddd"}},(0,r.createElement)("strong",null,"Wordsurf Change Preview:"),(0,r.createElement)(w.Button,{isPrimary:!0,onClick:()=>{const e=n[0];console.log("InlineDiffManager: Header accept clicked for diff block"),p("wordsurf-diff-preview"),a(null),l(!1),c.current.delete(e.tool_call_id),t(e)}},"Accept Changes"),(0,r.createElement)(w.Button,{isSecondary:!0,onClick:()=>{const e=n[0];console.log("InlineDiffManager: Header reject clicked for diff block"),p("wordsurf-diff-preview"),a(null),l(!1),c.current.delete(e.tool_call_id),s(e)}},"Reject"))))},G=({name:e,args:t,result:s,status:n})=>{let o=t;if("string"==typeof t)try{o=JSON.parse(t)}catch(e){}return(0,r.createElement)("div",{className:"tool-call"},(0,r.createElement)("div",{className:"tool-header"},"in_progress"===n?(0,r.createElement)("div",{className:"spinner"}):!0===s?.success?(0,r.createElement)("div",{className:"icon"},"âœ…"):!1===s?.success?(0,r.createElement)("div",{className:"icon"},"âŒ"):(0,r.createElement)("div",{className:"icon"},"âš™ï¸"),(0,r.createElement)("span",{className:"tool-name"},e)))},K=({message:e})=>"tool"===e.type?(0,r.createElement)("div",{className:`chat-message ${e.author}`},(0,r.createElement)(G,{name:e.tool_name,args:e.tool_args,result:e.result,status:e.result?"completed":"in_progress"})):(0,r.createElement)("div",{className:`chat-message ${e.author}`},(0,r.createElement)("div",{className:"chat-bubble"},e.content,e.isStreaming&&(0,r.createElement)("span",{className:"typing-indicator"},(0,r.createElement)("span",null),(0,r.createElement)("span",null),(0,r.createElement)("span",null)))),q=({value:e,onChange:t,onSend:s,disabled:n=!1,placeholder:o="Ask me to edit, write, or brainstorm..."})=>(0,r.createElement)("div",{className:"wordsurf-input-area"},(0,r.createElement)("textarea",{value:e,onChange:t,placeholder:o,disabled:n,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),s())}}),(0,r.createElement)("button",{onClick:s,disabled:n||!e.trim()},"Send")),Q=({diffs:e,onAcceptAll:t,onRejectAll:s})=>e&&0!==e.length?(console.log("PendingChanges: Rendering diff control UI for",e.length,"diffs"),(0,r.createElement)("div",{className:"wordsurf-pending-changes"},(0,r.createElement)("div",{className:"pending-changes-content"},(0,r.createElement)("div",{className:"pending-changes-label"},"Pending changes:"),(0,r.createElement)("div",{className:"pending-changes-actions"},(0,r.createElement)("button",{className:"button button-primary",onClick:t,style:{marginRight:"8px"}},"Accept All"),(0,r.createElement)("button",{className:"button button-secondary",onClick:s},"Reject All"))))):null,X=({messages:e,isWaiting:t,inputValue:s,onInputChange:n,onSend:o,isStreaming:i,hasStreamingAssistant:l,pendingDiffs:c,onAcceptAllChanges:d,onRejectAllChanges:u})=>{const g=a().useRef(null);return a().useEffect(()=>{g.current&&(g.current.scrollTop=g.current.scrollHeight)},[e]),(0,r.createElement)("div",{className:"wordsurf-sidebar-content"},(0,r.createElement)("div",{className:"wordsurf-chat-window",ref:g},e.map((e,t)=>(0,r.createElement)(K,{key:t,message:e})),t&&!l&&(0,r.createElement)("div",{className:"chat-message agent"},(0,r.createElement)("div",{className:"chat-bubble"},"Thinking...",(0,r.createElement)("span",{className:"typing-indicator"},(0,r.createElement)("span",null),(0,r.createElement)("span",null),(0,r.createElement)("span",null)))),(0,r.createElement)(Q,{diffs:c,onAcceptAll:d,onRejectAll:u})),(0,r.createElement)(q,{value:s,onChange:n,onSend:o,disabled:i}))};class Z{static removeDiffWrapper(e,t=!1){const{replaceBlocks:s}=wp.data.dispatch("core/block-editor"),{getBlocks:n}=wp.data.select("core/block-editor");if(!wp.data.select("core/block-editor").getBlock(e))throw new Error("Diff block not found");const o=n(e);if(!o||0===o.length){const{removeBlocks:t}=wp.data.dispatch("core/block-editor");return void t([e])}const r=o.map(e=>Z.removeDiffTags(e,t));return s(e,r),r}static removeDiffTags(e,t){const s={...e};if(s.attributes&&s.attributes.content){let e=s.attributes.content;t?(e=e.replace(/<del[^>]*>.*?<\/del>/gi,""),e=e.replace(/<ins[^>]*>(.*?)<\/ins>/gi,"$1")):(e=e.replace(/<ins[^>]*>.*?<\/ins>/gi,""),e=e.replace(/<del[^>]*>(.*?)<\/del>/gi,"$1")),s.attributes={...s.attributes,content:e}}return s.innerBlocks&&s.innerBlocks.length>0&&(s.innerBlocks=s.innerBlocks.map(e=>Z.removeDiffTags(e,t))),s}static smartTextReplace(e,t,s,n=!1){if(!e.includes("<"))return n?e.split(t).join(s):e.replace(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),s);const o=e.split(/(<[^>]+>)/);let r="";for(const e of o)e.startsWith("<")&&e.endsWith(">")?r+=e:r+=n?e.split(t).join(s):e.replace(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),s);return r}static canApplyDiff(e,t,s){const n=t||s;return e&&n&&e.includes(n)}}class ee{static findAllDiffBlocks(){const{getBlocks:e}=wp.data.select("core/block-editor");return e().filter(e=>"wordsurf/diff"===e.name)}static findDiffBlocksByDiffId(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.diffId===e)}static findDiffBlocksByToolCallId(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.toolCallId===e)}static hasDiffBlocks(){return this.findAllDiffBlocks().length>0}static getDiffBlockCount(){return this.findAllDiffBlocks().length}static findDiffBlockByClientId(e){return this.findAllDiffBlocks().find(t=>t.clientId===e)||null}static findDiffBlocksByStatus(e){return this.findAllDiffBlocks().filter(t=>t.attributes?.status===e)}static findPendingDiffBlocks(){return this.findDiffBlocksByStatus("pending")}static getOriginalBlockContent(e){return e.attributes?.originalBlockContent||""}static getOriginalBlockType(e){return e.attributes?.originalBlockType||"core/paragraph"}static isDiffBlock(e){return"wordsurf/diff"===e?.name}}class te{static async handleAccept(e,t,s,n=!1){const{toolCallId:o,diffId:r}=e;try{Z.removeDiffWrapper(t,!0);const e=await te.sendUserDecision("accepted",{tool_call_id:o,diff_id:r,post_id:s}),a=await e.json();if(a.continue_chat&&!n&&0===ee.findDiffBlocksByDiffId(r).filter(e=>"pending"===e.attributes?.status).length){const e=a.tool_result?.tool_call_id||o;te.triggerChatContinuation({action:"accepted",toolCallId:e,diffId:r,postId:s})}return{success:!0}}catch(e){throw console.error("Error accepting diff:",e),e}}static async handleReject(e,t,s,n=!1){const{toolCallId:o,diffId:r}=e;try{Z.removeDiffWrapper(t,!1);const e=await te.sendUserDecision("rejected",{tool_call_id:o,diff_id:r,post_id:s}),a=await e.json();if(a.continue_chat&&!n&&0===ee.findDiffBlocksByDiffId(r).filter(e=>"pending"===e.attributes?.status).length){const e=a.tool_result?.tool_call_id||o;te.triggerChatContinuation({action:"rejected",toolCallId:e,diffId:r,postId:s})}return{success:!0}}catch(e){throw console.error("Error rejecting diff:",e),e}}static async sendUserDecision(e,t){const s=new FormData;s.append("action","wordsurf_user_feedback"),s.append("nonce",window.wordsurfData?.nonce||""),s.append("user_action",e),s.append("tool_call_id",t.tool_call_id),s.append("diff_id",t.diff_id),s.append("post_id",t.post_id);const n=await fetch(window.wordsurfData?.ajax_url||"/wp-admin/admin-ajax.php",{method:"POST",body:s});if(!n.ok)throw new Error("Failed to send user decision");return n}static triggerChatContinuation(e){const t=new CustomEvent("wordsurf-continue-chat",{bubbles:!0,detail:{trigger:"diff_resolved",timestamp:Date.now(),toolResult:e}});document.dispatchEvent(t),console.log("DiffActions: Chat continuation event dispatched with tool result:",e)}static createActionHandlers(e,t,s,n,o){return{handleAccept:async()=>{n(!0);try{o({status:"accepted"}),await te.handleAccept(e,t,s)}catch(e){throw o({status:"pending"}),e}finally{n(!1)}},handleReject:async()=>{n(!0);try{o({status:"rejected"}),await te.handleReject(e,t,s)}catch(e){throw o({status:"pending"}),e}finally{n(!1)}}}}}class se{static async acceptAll(){const{getCurrentPostId:e}=wp.data.select("core/editor"),t=ee.findAllDiffBlocks(),s=e();console.log("HandleAcceptAll: Processing",t.length,"diff blocks");let n=null,o=null;for(let e=0;e<t.length;e++){const r=t[e],a=e===t.length-1;try{n=r.attributes.toolCallId,o=r.attributes.diffId,await te.handleAccept(r.attributes,r.clientId,s,!a),console.log("HandleAcceptAll: Accepted diff block",r.attributes.diffId)}catch(e){console.error("HandleAcceptAll: Error accepting diff block",r.attributes.diffId,e)}}return t.length>1&&n&&te.triggerChatContinuation({action:"accepted",toolCallId:n,diffId:o,postId:s,isAcceptAll:!0}),t.length}static async rejectAll(){const{getCurrentPostId:e}=wp.data.select("core/editor"),t=ee.findAllDiffBlocks(),s=e();console.log("HandleAcceptAll: Rejecting",t.length,"diff blocks");let n=null,o=null;for(let e=0;e<t.length;e++){const r=t[e],a=e===t.length-1;try{n=r.attributes.toolCallId,o=r.attributes.diffId,await te.handleReject(r.attributes,r.clientId,s,!a),console.log("HandleAcceptAll: Rejected diff block",r.attributes.diffId)}catch(e){console.error("HandleAcceptAll: Error rejecting diff block",r.attributes.diffId,e)}}return t.length>1&&n&&te.triggerChatContinuation({action:"rejected",toolCallId:n,diffId:o,postId:s,isAcceptAll:!0}),t.length}}const ne="wordsurf",oe=(0,c.__)("Wordsurf","wordsurf"),re=()=>(0,r.createElement)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},(0,r.createElement)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8 8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z",fill:"currentColor"}),(0,r.createElement)("path",{d:"M12 12m-6 0a6 6 0 1 0 12 0a6 6 0 1 0 -12 0",fill:"currentColor",fillOpacity:"0.3"}));wp.plugins.getPlugin(ne)||(0,i.registerPlugin)(ne,{render:()=>{const[e,t]=(0,d.useState)({originalContent:"",diffs:[]});(0,d.useEffect)(()=>{e.diffs.length>0&&console.log("WordsurfPlugin: diffContext has diffs:",e)},[e.diffs.length]);const s=(0,d.useRef)(new y([])),n=(0,u.useSelect)(e=>{const{getCurrentPostId:t,getEditedPostAttribute:s}=e("core/editor"),{getBlocks:n}=e("core/block-editor");return{postId:t(),title:s("title"),content:s("content"),status:s("status"),type:s("type"),blocks:n()}});(0,d.useEffect)(()=>{e.diffs.length>0&&n.blocks&&(ee.hasDiffBlocks()||(console.log("WordsurfPlugin: No diff blocks remaining in editor - resetting chat state"),t(e=>({...e,diffs:[]}))))},[n.blocks,e.diffs.length]);const o=(0,d.useCallback)(e=>{console.log("WordsurfPlugin: Received diff data:",e),console.log("WordsurfPlugin: Has diff_block_content:",!!e.diff_block_content),t(t=>({...t,diffs:[...t.diffs,e]}))},[]),a=(({postId:e,onDiffReceived:t,onUserDecision:s,chatHistory:n})=>{const o=(0,r.useRef)(null);o.current||(o.current=new f(n.current,t));const a=o.current,[i,l]=(0,r.useState)(a.getState()),[c,d]=(0,r.useState)(""),u=(0,r.useCallback)(()=>{l(a.getState())},[a]);(0,r.useEffect)(()=>()=>{a.cleanup()},[a]),(0,r.useEffect)(()=>{a.setInputValue(c)},[c,a]);const p=(0,r.useCallback)(()=>{const t=c.trim();!t||a.isStreaming||a.hasSentMessage||a.currentEventSource||(n.current.addUserMessage(t),u(),d(""),a.startStream(n.current.getOpenAIMessages(),e,g,u,u,u))},[c,a,n,e,u]),h=(0,r.useCallback)((e,t)=>{n.current.addUserDecision(e,t),u();const s=new FormData;s.append("action","wordsurf_tool_action"),s.append("action_type",e),s.append("tool_call_id",t.tool_call_id),s.append("tool_data",JSON.stringify(t)),s.append("nonce",window.wordsurfData?.nonce||""),fetch(window.wordsurfData.ajax_url,{method:"POST",body:s}).then(e=>e.json()).then(e=>{e.success?console.log("Tool action processed successfully:",e):console.error("Tool action failed:",e)}).catch(e=>{console.error("Error processing tool action:",e)})},[n,u]),m=(0,r.useCallback)(()=>{console.log("ChatHandler: Resetting for continuation"),a.hasSentMessage=!1,a.isStreaming=!1,a.isWaiting=!1,u()},[a,u]),_=(0,r.useCallback)(e=>{if(console.log("ChatHandler: Continuing with tool result:",e),a.isStreaming||a.hasSentMessage||a.currentEventSource)return void console.log("ChatHandler: Cannot continue - already streaming or has sent message");const t=new FormData;t.append("action","wordsurf_continue_with_tool_result"),t.append("nonce",window.wordsurfData?.nonce||""),t.append("tool_call_id",e.toolCallId),t.append("user_action",e.action),t.append("post_id",e.postId),t.append("messages",JSON.stringify(n.current.getOpenAIMessages()));const s=new URLSearchParams;for(const[e,n]of t.entries())s.append(e,n);const o=new EventSource(`${window.wordsurfData?.ajax_url}?${s.toString()}`);a.isStreaming=!0,a.hasSentMessage=!0,a.isWaiting=!0,a.currentEventSource=o,u(),o.onmessage=e=>{try{const t=JSON.parse(e.data);a.handleEvent(t)}catch(e){console.error("Error parsing SSE data:",e)}},o.onerror=e=>{console.error("EventSource error:",e),o.close(),a.isStreaming=!1,a.isWaiting=!1,a.hasSentMessage=!1,a.currentEventSource=null,u()},o.onopen=()=>{console.log("Tool result continuation stream opened")}},[a,n,u]);return{isStreaming:i.isStreaming,isWaiting:i.isWaiting,inputValue:c,setInputValue:d,uiMessages:i.uiMessages,handleSend:p,updateUIMessages:u,recordUserDecision:h,resetForContinuation:m,continueWithToolResult:_,hasStreamingAssistant:i.hasStreamingAssistant,currentEventSource:a.currentEventSource}})({postId:n.postId,onDiffReceived:o,chatHistory:s});(0,d.useEffect)(()=>{const e=e=>{console.log("WordsurfPlugin: Chat continuation event received:",e.detail);const{toolResult:s}=e.detail;if(s&&s.isAcceptAll&&(console.log("WordsurfPlugin: Clearing pending diffs for accept all operation"),t(e=>({...e,diffs:[]}))),!a||a.isStreaming||a.isWaiting||a.currentEventSource)console.log("WordsurfPlugin: Skipping chat continuation - already streaming or waiting",{isStreaming:a?.isStreaming,isWaiting:a?.isWaiting,hasEventSource:!!a?.currentEventSource});else{console.log("WordsurfPlugin: Triggering model-driven continuation with tool result");const{toolResult:t}=e.detail;t&&t.toolCallId?a.continueWithToolResult(t):a.resetForContinuation()}};return document.addEventListener("wordsurf-continue-chat",e),()=>{document.removeEventListener("wordsurf-continue-chat",e)}},[a]);const i=(0,d.useCallback)(e=>{s.current.addUserDecision("accepted",e),t(t=>({...t,diffs:t.diffs.filter(t=>t.tool_call_id!==e.tool_call_id)}))},[s]),c=(0,d.useCallback)(e=>{s.current.addUserDecision("rejected",e),t(t=>({...t,diffs:t.diffs.filter(t=>t.tool_call_id!==e.tool_call_id)}))},[s]),p=(0,d.useCallback)(async()=>{console.log("WordsurfPlugin: Accept all clicked");try{const n=await se.acceptAll();console.log("WordsurfPlugin: Accepted",n,"diff blocks"),e.diffs.forEach(e=>{s.current.addUserDecision("accepted",e)}),t(e=>({...e,diffs:[]}))}catch(e){console.error("WordsurfPlugin: Error accepting all changes:",e)}},[e.diffs,a]),h=(0,d.useCallback)(async()=>{console.log("WordsurfPlugin: Reject all clicked");try{const n=await se.rejectAll();console.log("WordsurfPlugin: Rejected",n,"diff blocks"),e.diffs.forEach(e=>{s.current.addUserDecision("rejected",e)}),t(e=>({...e,diffs:[]}))}catch(e){console.error("WordsurfPlugin: Error rejecting all changes:",e)}},[e.diffs,a]),m=(0,d.useCallback)(()=>{t(e=>({...e,originalContent:n.content,diffs:[]})),a.handleSend()},[n.content,a,t]);return(0,r.createElement)(r.Fragment,null,(0,r.createElement)(l.PluginSidebarMoreMenuItem,{target:ne},oe),(0,r.createElement)(l.PluginSidebar,{name:ne,title:oe,icon:(0,r.createElement)(re,null)},(0,r.createElement)(X,{messages:a.uiMessages,isWaiting:a.isWaiting,inputValue:a.inputValue,onInputChange:e=>a.setInputValue(e.target.value),onSend:m,isStreaming:a.isStreaming,hasStreamingAssistant:a.hasStreamingAssistant,pendingDiffs:e.diffs,onAcceptAllChanges:p,onRejectAllChanges:h})),(0,r.createElement)(Y,{diffContext:e,onAccept:i,onReject:c,key:`diff-manager-${e.diffs.length}`}))}})})();